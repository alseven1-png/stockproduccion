<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n - Producci√≥n</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; }
        
        /* ENCABEZADO */
        header { background-color: #333; color: white; padding: 15px; text-align: center; }
        header h1 { margin: 0; font-size: 1.5rem; }

        /* PESTA√ëAS DE NAVEGACI√ìN */
        .tabs { display: flex; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #555; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab:hover { background-color: #f8f9fa; color: #007bff; }
        .tab.active { border-bottom: 3px solid #007bff; color: #007bff; }

        /* CONTENEDOR */
        .container { max-width: 900px; margin: 0 auto; padding: 0 15px; display: none; }
        .container.active { display: block; }

        /* TARJETAS */
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* FORMULARIOS */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        select, input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        textarea { height: 150px; font-family: monospace; }

        /* BOTONES */
        button { width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-green { background-color: #28a745; color: white; }
        .btn-green:hover { background-color: #218838; }
        .btn-blue { background-color: #007bff; color: white; }
        .btn-blue:hover { background-color: #0056b3; }
        
        /* TABLA */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #555; }
        
        .stock-positivo { color: #28a745; font-weight: bold; }
        .stock-negativo { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <h1>üè≠ CONTROL DE PRODUCCI√ìN WEB</h1>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="cambiarPestana('cargar')">üìù CARGAR</div>
        <div class="tab" onclick="cambiarPestana('historial')">üìã HISTORIAL</div>
        <div class="tab" onclick="cambiarPestana('config')">‚öôÔ∏è CONFIGURACI√ìN</div>
    </div>

    <div id="vista-cargar" class="container active">
        <div class="card">
            <h3>Nuevo Movimiento</h3>
            <div class="form-group">
                <label>Categor√≠a</label>
                <select id="sel-categoria" onchange="cargarListaProductos()">
                    <option value="panaderia">Panader√≠a</option>
                    <option value="pasteleria">Pasteler√≠a</option>
                    <option value="cocina">Cocina</option>
                </select>
            </div>
            <div class="form-group">
                <label>Producto</label>
                <select id="sel-producto">
                    <option>Cargando...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Acci√≥n</label>
                <select id="sel-accion">
                    <option value="ENTRADA">‚ûï PRODUCCI√ìN (Entrada)</option>
                    <option value="SALIDA">‚ûñ DESCARTE (Salida)</option>
                    <option value="REUTILIZACION">üîÑ REUTILIZACI√ìN</option>
                </select>
            </div>
            <div class="form-group">
                <label>Cantidad</label>
                <input type="number" id="inp-cantidad" placeholder="0">
            </div>
            <div class="form-group">
                <label>Operario</label>
                <select id="sel-operario"><option>-</option></select>
            </div>
            <button class="btn-green" onclick="guardarMovimiento()">GUARDAR</button>
        </div>
    </div>

    <div id="vista-historial" class="container">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>√öltimos Movimientos</h3>
                <button onclick="cargarHistorial()" style="width:auto; padding:5px 15px; font-size:12px;">üîÑ</button>
            </div>
            <div style="overflow-x:auto;">
                <table id="tabla-historial">
                    <thead>
                        <tr><th>Fecha</th><th>Producto</th><th>Tipo</th><th>Cant</th><th>Operario</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="vista-config" class="container">
        <div class="card" style="border-top: 4px solid #ffc107;">
            <h3>Administrar Productos (CSV)</h3>
            <p style="font-size:12px; color:#666;">Formato: <b>ID,Nombre,Unidad,Alterno,Factor,StockInicial</b></p>
            
            <div class="form-group">
                <label>Panader√≠a</label>
                <textarea id="csv-panaderia"></textarea>
            </div>
            <div class="form-group">
                <label>Pasteler√≠a</label>
                <textarea id="csv-pasteleria"></textarea>
            </div>
            <div class="form-group">
                <label>Cocina</label>
                <textarea id="csv-cocina"></textarea>
            </div>
            <div class="form-group">
                <label>Operarios (separados por coma)</label>
                <input type="text" id="csv-operarios">
            </div>
            
            <button class="btn-blue" onclick="guardarConfiguracion()">üíæ GUARDAR CAMBIOS</button>
        </div>
    </div>

    <script>
        // =======================================================
        // ‚ö†Ô∏è PEGA AQU√ç TUS CREDENCIALES DE FIREBASE
        // =======================================================
        const firebaseConfig = {
            apiKey: "2550LP",
            authDomain: "TU_DOMINIO.firebaseapp.com",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_BUCKET",
            messagingSenderId: "TU_SENDER_ID",
            appId: "TU_APP_ID"
        };

        // Inicializar Firebase
        if (!firebase.apps.length) {
            try { firebase.initializeApp(firebaseConfig); } 
            catch (e) { console.error("Error Firebase:", e); }
        }
        const db = firebase.firestore();

        // VARIABLES GLOBALES
        const CATEGORIAS = ['panaderia', 'pasteleria', 'cocina'];

        // --- NAVEGACI√ìN ---
        function cambiarPestana(id) {
            document.querySelectorAll('.container').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('vista-' + id).classList.add('active');
            
            // Activar estilo pesta√±a
            const index = id === 'cargar' ? 0 : (id === 'historial' ? 1 : 2);
            document.querySelectorAll('.tab')[index].classList.add('active');
        }

        // --- CARGAR DATOS INICIALES ---
        async function cargarTodo() {
            cargarListaProductos();
            cargarConfiguracionUI();
        }

        // --- 1. L√ìGICA DE CARGA DE PRODUCTOS EN SELECT ---
        async function cargarListaProductos() {
            const cat = document.getElementById('sel-categoria').value;
            const select = document.getElementById('sel-producto');
            select.innerHTML = '<option>Cargando...</option>';

            try {
                const doc = await db.collection('configuracion').doc('productos_' + cat).get();
                if (doc.exists && doc.data().json_data) {
                    select.innerHTML = '';
                    const lista = doc.data().json_data;
                    lista.sort((a,b) => a.nombre.localeCompare(b.nombre));
                    
                    lista.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.text = p.nombre;
                        select.appendChild(opt);
                    });
                } else {
                    select.innerHTML = '<option>Sin productos</option>';
                }
            } catch (e) { console.error(e); }
        }

        // --- 2. GUARDAR MOVIMIENTO ---
        async function guardarMovimiento() {
            const cat = document.getElementById('sel-categoria').value;
            const pid = document.getElementById('sel-producto').value;
            const pnom = document.getElementById('sel-producto').options[document.getElementById('sel-producto').selectedIndex].text;
            const acc = document.getElementById('sel-accion').value;
            const cant = parseFloat(document.getElementById('inp-cantidad').value);
            const op = document.getElementById('sel-operario').value;

            if (!pid || cant <= 0) return alert("Revise los datos");

            try {
                await db.collection('movimientos').add({
                    fecha: new Date().toISOString(),
                    productoId: pid,
                    productoNombre: pnom,
                    categoria: cat,
                    tipo: acc,
                    cantidadBase: cant,
                    operario: op,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("Guardado OK");
                document.getElementById('inp-cantidad').value = '';
            } catch (e) { alert("Error: " + e.message); }
        }

        // --- 3. HISTORIAL ---
        async function cargarHistorial() {
            const tbody = document.querySelector('#tabla-historial tbody');
            tbody.innerHTML = '<tr><td>Cargando...</td></tr>';
            
            const snap = await db.collection('movimientos').orderBy('timestamp', 'desc').limit(15).get();
            tbody.innerHTML = '';
            
            snap.forEach(doc => {
                const d = doc.data();
                const fecha = d.timestamp ? d.timestamp.toDate().toLocaleDateString() : '-';
                const color = d.tipo === 'ENTRADA' ? 'green' : (d.tipo === 'SALIDA' ? 'red' : 'blue');
                
                tbody.innerHTML += `
                    <tr>
                        <td>${fecha}</td>
                        <td>${d.productoNombre}</td>
                        <td style="color:${color}">${d.tipo}</td>
                        <td>${d.cantidadBase}</td>
                        <td>${d.operario || '-'}</td>
                    </tr>
                `;
            });
        }

        // --- 4. CONFIGURACI√ìN (LO QUE ARREGLA EL PYTHON) ---
        async function cargarConfiguracionUI() {
            for (const c of CATEGORIAS) {
                const doc = await db.collection('configuracion').doc('productos_' + c).get();
                if (doc.exists) document.getElementById('csv-' + c).value = doc.data().csv || '';
            }
            
            const ops = await db.collection('configuracion').doc('operarios_lista').get();
            if (ops.exists) {
                document.getElementById('csv-operarios').value = ops.data().lista || '';
                actualizarSelectOperarios(ops.data().lista);
            }
        }

        async function guardarConfiguracion() {
            const btn = document.querySelector('#vista-config button');
            btn.innerText = "GUARDANDO..."; btn.disabled = true;

            try {
                // GUARDAR PRODUCTOS
                for (const c of CATEGORIAS) {
                    const csv = document.getElementById('csv-' + c).value;
                    const json = procesarCSV(csv, c);
                    
                    // ESTA L√çNEA ES LA MAGIA: Guarda 'json_data' limpio para Python
                    await db.collection('configuracion').doc('productos_' + c).set({
                        csv: csv,
                        json_data: json,
                        ultima_actualizacion: new Date().toISOString()
                    });
                }

                // GUARDAR OPERARIOS
                const ops = document.getElementById('csv-operarios').value;
                await db.collection('configuracion').doc('operarios_lista').set({ lista: ops });

                alert("‚úÖ DATOS GUARDADOS CORRECTAMENTE.\nAhora Python deber√≠a funcionar.");
                location.reload();

            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                btn.innerText = "üíæ GUARDAR CAMBIOS"; btn.disabled = false;
            }
        }

        function procesarCSV(csv, cat) {
            const res = [];
            csv.split('\n').forEach(line => {
                const p = line.split(',');
                if (p.length >= 2) {
                    const id = p[0].trim();
                    if(id) {
                        res.push({
                            id: id,
                            nombre: p[1].trim(),
                            unidad: p[2]?.trim() || 'Unidad',
                            alterno: p[3]?.trim() || '-',
                            factor: p[4]?.trim() || '1',
                            stockInicial: p[5]?.trim() || '0',
                            categoria: cat
                        });
                    }
                }
            });
            return res;
        }

        function actualizarSelectOperarios(listaStr) {
            const sel = document.getElementById('sel-operario');
            sel.innerHTML = '<option value="-">-</option>';
            if(listaStr) {
                listaStr.split(',').forEach(o => {
                    const opt = document.createElement('option');
                    opt.value = o.trim(); opt.text = o.trim();
                    sel.appendChild(opt);
                });
            }
        }

        // INICIO
        cargarTodo();

    </script>
</body>
</html>
