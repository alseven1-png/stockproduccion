<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Stock - Producci√≥n</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e9ecef; margin: 0; padding: 0; }
        
        /* HEADER */
        .header { background-color: #343a40; color: white; padding: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; font-size: 24px; letter-spacing: 1px; }

        /* NAVEGACI√ìN (Pesta√±as) */
        .nav-tabs { display: flex; justify-content: center; background-color: #fff; padding: 0; list-style: none; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .nav-item { padding: 15px 30px; cursor: pointer; font-weight: bold; color: #6c757d; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .nav-item:hover { color: #007bff; background-color: #f8f9fa; }
        .nav-item.active { color: #007bff; border-bottom: 3px solid #007bff; }

        /* CONTENIDO PRINCIPAL */
        .container { max-width: 800px; margin: 30px auto; padding: 20px; }
        .vista { display: none; animation: fadeIn 0.5s; }
        .vista.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* TARJETAS */
        .card { background: white; border-radius: 8px; padding: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card h2 { margin-top: 0; color: #343a40; border-bottom: 2px solid #f1f1f1; padding-bottom: 10px; margin-bottom: 20px; font-size: 18px; }

        /* FORMULARIOS */
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #495057; }
        select, input, textarea { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 16px; box-sizing: border-box; transition: border 0.3s; }
        select:focus, input:focus, textarea:focus { border-color: #80bdff; outline: none; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        textarea { height: 120px; font-family: monospace; font-size: 14px; }

        /* BOTONES */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s; text-transform: uppercase; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: #dc3545; color: white; margin-top: 10px; }
        
        /* TABLAS */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background-color: #e9ecef; color: #495057; font-weight: bold; }
        tr:hover { background-color: #f8f9fa; }

        /* MENSAJES */
        .alerta { padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none; }
        .alerta-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alerta-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ü•ê CONTROL DE STOCK Y PRODUCCI√ìN</h1>
    </div>

    <ul class="nav-tabs">
        <li class="nav-item active" onclick="mostrarVista('cargar')">üìù CARGAR</li>
        <li class="nav-item" onclick="mostrarVista('historial')">üìã HISTORIAL</li>
        <li class="nav-item" onclick="mostrarVista('config')">‚öôÔ∏è CONFIGURACI√ìN</li>
    </ul>

    <div class="container">
        <div id="mensaje-exito" class="alerta alerta-success">Operaci√≥n realizada con √©xito.</div>
        <div id="mensaje-error" class="alerta alerta-error">Ocurri√≥ un error.</div>

        <div id="vista-cargar" class="vista active">
            <div class="card">
                <h2>NUEVO MOVIMIENTO</h2>
                <div class="form-group">
                    <label>Categor√≠a</label>
                    <select id="sel-categoria" onchange="cargarProductos()">
                        <option value="panaderia">ü•ñ Panader√≠a</option>
                        <option value="pasteleria">üç∞ Pasteler√≠a</option>
                        <option value="cocina">üç≥ Cocina</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Producto</label>
                    <select id="sel-producto">
                        <option>Cargando...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Acci√≥n</label>
                    <select id="sel-accion">
                        <option value="ENTRADA">üü¢ PRODUCCI√ìN (Entrada)</option>
                        <option value="SALIDA">üî¥ DESCARTE / MERMA (Salida)</option>
                        <option value="REUTILIZACION">üîÑ REUTILIZACI√ìN (Neutro)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cantidad</label>
                    <input type="number" id="inp-cantidad" placeholder="Ej: 10" step="0.1">
                </div>
                <div class="form-group">
                    <label>Operario</label>
                    <select id="sel-operario">
                        <option value="-">-- Seleccionar --</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="guardarMovimiento()">GUARDAR MOVIMIENTO</button>
            </div>
        </div>

        <div id="vista-historial" class="vista">
            <div class="card">
                <h2>√öLTIMOS MOVIMIENTOS</h2>
                <button class="btn btn-primary" onclick="cargarHistorial()" style="margin-bottom: 15px;">üîÑ ACTUALIZAR LISTA</button>
                <div style="overflow-x: auto;">
                    <table id="tabla-historial">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Producto</th>
                                <th>Acci√≥n</th>
                                <th>Cant.</th>
                                <th>Operario</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" style="text-align:center">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="vista-config" class="vista">
            <div class="card" style="border-left: 5px solid #ffc107;">
                <h2>‚öôÔ∏è GESTI√ìN DE PRODUCTOS (CSV)</h2>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                    Formato: <b>ID, Nombre, Unidad, Alternativo, Factor, StockInicial</b><br>
                    <i>Ej: P01, Media Luna, Unidad, Docena, 12, 100</i>
                </p>

                <div class="form-group">
                    <label>ü•ñ PRODUCTOS PANADER√çA</label>
                    <textarea id="config-panaderia"></textarea>
                </div>

                <div class="form-group">
                    <label>üç∞ PRODUCTOS PASTELER√çA</label>
                    <textarea id="config-pasteleria"></textarea>
                </div>

                <div class="form-group">
                    <label>üç≥ PRODUCTOS COCINA</label>
                    <textarea id="config-cocina"></textarea>
                </div>

                <div class="form-group">
                    <label>üë∑ LISTA DE OPERARIOS (Separados por coma)</label>
                    <input type="text" id="config-operarios" placeholder="Juan, Maria, Pedro">
                </div>

                <button class="btn btn-primary" onclick="guardarConfiguracion()">üíæ GUARDAR CAMBIOS Y SINCRONIZAR</button>
                <br><br>
                <p style="font-size: 12px; color: #888; text-align: center;">
                    * Al guardar, se sincroniza autom√°ticamente con el sistema Python.
                </p>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // ‚ö†Ô∏è PEGA AQU√ç TUS CREDENCIALES DE FIREBASE (ServiceAccountKey NO, el config web)
        // =================================================================
        const firebaseConfig = {
            apiKey: "2550LP",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            projectId: "TU_PROYECTO",
            storageBucket: "TU_PROYECTO.appspot.com",
            messagingSenderId: "NUMERO",
            appId: "ID"
        };

        // INICIALIZACI√ìN SEGURA
        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
            } catch (e) {
                console.error("Error inicializando Firebase. ¬øPegaste las claves?", e);
            }
        }
        const db = firebase.firestore();

        // =================================================================
        // L√ìGICA DEL SISTEMA
        // =================================================================
        
        // 1. NAVEGACI√ìN
        function mostrarVista(vistaId) {
            document.querySelectorAll('.vista').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
            
            document.getElementById('vista-' + vistaId).classList.add('active');
            // Activar tab correspondiente (l√≥gica simple)
            const tabs = document.querySelectorAll('.nav-item');
            if(vistaId === 'cargar') tabs[0].classList.add('active');
            if(vistaId === 'historial') tabs[1].classList.add('active');
            if(vistaId === 'config') tabs[2].classList.add('active');
        }

        // 2. CARGAR PRODUCTOS EN SELECT (Pesta√±a Cargar)
        async function cargarProductos() {
            const cat = document.getElementById('sel-categoria').value;
            const select = document.getElementById('sel-producto');
            select.innerHTML = '<option>Cargando...</option>';

            try {
                const doc = await db.collection('configuracion').doc('productos_' + cat).get();
                select.innerHTML = '';
                
                if (doc.exists && doc.data().json_data) {
                    const productos = doc.data().json_data;
                    productos.sort((a, b) => a.nombre.localeCompare(b.nombre)); // Ordenar A-Z
                    
                    productos.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.text = p.nombre;
                        select.appendChild(opt);
                    });
                } else {
                    select.innerHTML = '<option>No hay productos cargados</option>';
                }
            } catch (error) {
                console.error(error);
                select.innerHTML = '<option>Error cargando</option>';
            }
        }

        // 3. GUARDAR MOVIMIENTO (Producci√≥n)
        async function guardarMovimiento() {
            const categoria = document.getElementById('sel-categoria').value;
            const productoId = document.getElementById('sel-producto').value;
            const productoNombre = document.getElementById('sel-producto').options[document.getElementById('sel-producto').selectedIndex].text;
            const accion = document.getElementById('sel-accion').value;
            const cantidad = parseFloat(document.getElementById('inp-cantidad').value);
            const operario = document.getElementById('sel-operario').value;

            if (!productoId || isNaN(cantidad) || cantidad <= 0) {
                alert("Por favor, complete todos los campos correctamente.");
                return;
            }

            try {
                // A) Guardar en Historial
                await db.collection('movimientos').add({
                    fecha: new Date().toISOString(), // Fecha ISO completa para orden
                    fecha_corta: new Date().toLocaleDateString(),
                    productoId: productoId,
                    productoNombre: productoNombre,
                    categoria: categoria,
                    tipo: accion,
                    cantidadBase: cantidad, // Siempre positivo aqu√≠, la l√≥gica de resta se hace al leer
                    operario: operario,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                mostrarMensaje('mensaje-exito', 'Movimiento guardado correctamente.');
                document.getElementById('inp-cantidad').value = '';
                
            } catch (error) {
                console.error(error);
                mostrarMensaje('mensaje-error', 'Error al guardar: ' + error.message);
            }
        }

        // 4. HISTORIAL
        async function cargarHistorial() {
            const tbody = document.querySelector('#tabla-historial tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Cargando...</td></tr>';

            try {
                // Traer √∫ltimos 20 movimientos
                const q = await db.collection('movimientos')
                                  .orderBy('timestamp', 'desc')
                                  .limit(20)
                                  .get();

                tbody.innerHTML = '';
                q.forEach(doc => {
                    const d = doc.data();
                    const fecha = d.timestamp ? d.timestamp.toDate().toLocaleString() : 'Reciente';
                    const color = d.tipo === 'SALIDA' ? '#dc3545' : (d.tipo === 'ENTRADA' ? '#28a745' : '#007bff');
                    
                    const row = `<tr>
                        <td>${fecha}</td>
                        <td>${d.productoNombre}</td>
                        <td style="color:${color}; font-weight:bold">${d.tipo}</td>
                        <td>${d.cantidadBase}</td>
                        <td>${d.operario || '-'}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="5">Error cargando historial</td></tr>';
            }
        }

        // 5. CONFIGURACI√ìN (LO M√ÅS IMPORTANTE PARA PYTHON)
        async function cargarConfiguracion() {
            const cats = ['panaderia', 'pasteleria', 'cocina'];
            
            for (const c of cats) {
                const doc = await db.collection('configuracion').doc('productos_' + c).get();
                if (doc.exists) {
                    document.getElementById('config-' + c).value = doc.data().csv || '';
                }
            }
            
            const ops = await db.collection('configuracion').doc('operarios_lista').get();
            if (ops.exists) {
                document.getElementById('config-operarios').value = ops.data().lista || '';
            }
            
            cargarOperariosSelect(); // Actualizar desplegable
        }

        async function guardarConfiguracion() {
            const btn = document.querySelector('#vista-config button');
            btn.innerText = "GUARDANDO... ESPERE";
            btn.disabled = true;

            try {
                const cats = ['panaderia', 'pasteleria', 'cocina'];
                
                for (const c of cats) {
                    const csv = document.getElementById('config-' + c).value;
                    const jsonData = procesarCSV(csv, c);
                    
                    // ESTO ES LO QUE ARREGLA EL PYTHON: Guardar 'json_data' limpio
                    await db.collection('configuracion').doc('productos_' + c).set({
                        csv: csv,
                        json_data: jsonData,
                        ultima_actualizacion: new Date().toISOString()
                    });
                }

                // Guardar Operarios
                const listaOps = document.getElementById('config-operarios').value;
                await db.collection('configuracion').doc('operarios_lista').set({ lista: listaOps });

                alert("‚úÖ Configuraci√≥n guardada y sistema sincronizado.");
                cargarOperariosSelect();
                cargarProductos(); // Recargar select principal

            } catch (error) {
                alert("Error al guardar: " + error.message);
            } finally {
                btn.innerText = "üíæ GUARDAR CAMBIOS Y SINCRONIZAR";
                btn.disabled = false;
            }
        }

        // Funci√≥n auxiliar para convertir el CSV del usuario en objetos para Python
        function procesarCSV(csvText, categoria) {
            const lineas = csvText.split('\n');
            const resultado = [];
            
            lineas.forEach(linea => {
                const campos = linea.split(',');
                if (campos.length >= 2) {
                    const id = campos[0].trim();
                    const nombre = campos[1].trim();
                    if (id && nombre) {
                        resultado.push({
                            id: id,
                            nombre: nombre,
                            unidad: campos[2] ? campos[2].trim() : 'Unidad',
                            alterno: campos[3] ? campos[3].trim() : '-',
                            factor: campos[4] ? campos[4].trim() : '1',
                            stockInicial: campos[5] ? campos[5].trim() : '0',
                            categoria: categoria
                        });
                    }
                }
            });
            return resultado;
        }

        async function cargarOperariosSelect() {
            const select = document.getElementById('sel-operario');
            select.innerHTML = '<option value="-">-- Seleccionar --</option>';
            try {
                const doc = await db.collection('configuracion').doc('operarios_lista').get();
                if (doc.exists && doc.data().lista) {
                    const lista = doc.data().lista.split(',');
                    lista.forEach(op => {
                        const opt = document.createElement('option');
                        opt.value = op.trim();
                        opt.text = op.trim();
                        select.appendChild(opt);
                    });
                }
            } catch(e) {}
        }

        function mostrarMensaje(id, texto) {
            const el = document.getElementById(id);
            el.innerText = texto;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 3000);
        }

        // INICIALIZAR
        cargarConfiguracion();
        cargarProductos();

    </script>
</body>
</html>
