<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Stock de Producción - Panadería</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, setLogLevel, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        // (Esta es la configuración de tu primer archivo, la cual es correcta)
        const firebaseConfig = {
          apiKey: "AIzaSyBKV1mVfhFZJgeZRu6FHgz-2_KVrKDlHoc",
          authDomain: "mercaderia-f1699.firebaseapp.com",
          projectId: "mercaderia-f1699",
          storageBucket: "mercaderia-f1699.firebasestorage.app",
          messagingSenderId: "230493635490",
          appId: "1:230493635490:web:f4b780864dbc64eebda8fb"
        };

        // CORRECCIÓN 1: Inicializar Firebase UNA SOLA VEZ
        // Llamamos a initializeApp() una vez y guardamos la instancia.
        const app = initializeApp(firebaseConfig);
        
        // Asignamos esa MISMA instancia al objeto window para el script principal
        window.firebaseApp = app; 
        window.auth = getAuth(app); // Usamos la instancia 'app'
        window.db = getFirestore(app); // Usamos la instancia 'app'
        
        // Habilitar logs para depuración de Firestore
        setLogLevel('Debug');
        
        // Exportar funciones y variables necesarias al ámbito global
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.collection = collection;
        window.addDoc = addDoc;
        window.query = query;
        window.onSnapshot = onSnapshot;
        // Accede a la propiedad 'appId' del objeto 'firebaseConfig'
        window.appId = firebaseConfig.appId;
        // Nuevas exportaciones para configuración de base de datos
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
    </script>
    <style>
        .nav-tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 4px solid transparent;
            transition: all 0.3s ease;
        }
        .nav-tab:hover {
            background-color: #a16207; 
        }
        .nav-tab.active-tab {
            border-color: #f59e0b; 
            color: #ffffff;
            font-weight: 600;
        }
        .view {
            display: none;
        }
        .view.active-view {
            display: block;
        }
    </style>
</head>
<body class="bg-amber-50 font-sans text-amber-900">

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center flex-wrap">
            <h1 class="text-2xl sm:text-3xl font-bold text-amber-900">Gestor de Stock de Producción</h1>
            <div class="mt-2 sm:mt-0 text-right text-xs text-amber-700">
                <p>Usuario Actual (ID):</p>
                <p id="user-id" class="font-mono text-amber-900 font-semibold truncate">Cargando...</p>
            </div>
        </div>
    </header>

    <nav class="bg-amber-800 text-amber-100 shadow-lg">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row">
            <button id="nav-panel" class="nav-tab active-tab">Panel de Stock</button>
            <button id="nav-registrar" class="nav-tab">Registrar Movimiento</button>
            <button id="nav-historial" class="nav-tab">Historial</button>
            <button id="nav-configuracion" class="nav-tab">Configuración</button>
        </div>
    </nav>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <div id="toast-message" class="hidden fixed top-20 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50">
            Movimiento registrado con éxito.
        </div>

                <section id="view-panel" class="view active-view space-y-6">
            <p class="text-lg text-amber-800">
                Bienvenido al Panel de Stock de Producción. Aquí puede monitorear el estado actual de su inventario, ver la producción total del día para el traspaso de lote y consultar los detalles de cada producto. **Los datos se actualizan en tiempo real.**
            </p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-amber-800">Stock Global (Base)</h3>
                    <p id="kpi-total-unidades" class="text-4xl font-bold text-amber-900">0</p>
                    <span class="text-sm text-gray-500">(Stock total en unidades base: Unidades, Kg, Porciones)</span>
                </div>
                                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-amber-800">Producción Total (Hoy)</h3>
                    <p id="kpi-produccion-hoy" class="text-4xl font-bold text-green-600">0</p>
                    <span class="text-sm text-gray-500">(Suma de todas las Entradas de hoy, en sus unidades base)</span>
                </div>
                                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-amber-800">Productos con Stock Bajo</h3>
                    <p id="kpi-stock-bajo" class="text-4xl font-bold text-red-600">0</p>
                    <span class="text-sm text-gray-500">(Productos bajo el límite de 20 unidades base)</span>
                </div>
            </div>
            
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-amber-900">Niveles de Stock (Unidades Base)</h2>
                <div class="chart-container" style="position: relative; height: 50vh; max-height: 450px; width: 100%; max-width: 1000px; margin-left: auto; margin-right: auto;">
                    <canvas id="stockChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-amber-900">Inventario Detallado</h2>
                <input id="searchInput" type="text" placeholder="Buscar producto por nombre..." class="w-full p-3 border border-amber-300 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-amber-500">
                <div class="overflow-x-auto">
                    <table class="w-full min-w-max">
                        <thead class="bg-amber-100">
                            <tr>
                                <th class="p-3 text-left font-semibold text-amber-800">CÓDIGO</th>
                                <th class="p-3 text-left font-semibold text-amber-800">Producto</th>
                                <th class="p-3 text-left font-semibold text-amber-800">Unidad Base</th>
                                <th class="p-3 text-left font-semibold text-amber-800">Stock (Base)</th>
                                <th class="p-3 text-left font-semibold text-amber-800">Stock (Alterno)</th>
                                <th class="p-3 text-left font-semibold text-amber-800">Formato Alterno</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <tr><td colspan="6" class="p-4 text-center text-gray-500">Cargando datos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

                <section id="view-registrar" class="view">
            <p class="text-lg text-amber-800 mb-6 max-w-2xl mx-auto">
                Utilice este formulario para registrar nuevas producciones (Entradas) o ventas/consumos (Salidas). Los datos se actualizarán en el panel de control automáticamente.
            </p>
            <form id="cargaForm" class="bg-white p-6 sm:p-8 rounded-lg shadow-md max-w-2xl mx-auto space-y-6">
                <div>
                    <label for="producto" class="block text-sm font-medium text-amber-800 mb-1">Producto</label>
                    <select id="producto" name="producto" required class="w-full p-3 border border-amber-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </select>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label for="tipo" class="block text-sm font-medium text-amber-800 mb-1">Tipo de Movimiento</label>
                        <select id="tipo" name="tipo" required class="w-full p-3 border border-amber-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="ENTRADA">ENTRADA (Producción)</option>
                            <option value="SALIDA">SALIDA (Venta/Consumo)</option>
                        </select>
                    </div>
                    <div>
                        <label for="formato" class="block text-sm font-medium text-amber-800 mb-1">Formato de Registro</label>
                        <select id="formato" name="formato" required class="w-full p-3 border border-amber-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                      S</select>
                    </div>
                </div>

                <div>
                    <label for="cantidad" class="block text-sm font-medium text-amber-800 mb-1">Cantidad</label>
                    <input type="number" id="cantidad" name="cantidad" min="0.01" step="0.01" required class="w-full p-3 border border-amber-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Ej: 2 (para latas) o 15 (para unidades/Kg)">
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                        <div>
                        <label for="operario" class="block text-sm font-medium text-amber-800 mb-1">Operario</label>
                        <select id="operario" name="operario" required class="w-full p-3 border border-amber-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                                                    </select>
                    </div>
                    <div>
                        <label for="fecha" class="block text-sm font-medium text-amber-800 mb-1">Fecha y Hora</label>
                        <input type="datetime-local" id="fecha" name="fecha" required class="w-full p-3 border border-amber-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>

                <div>
                    <button type="submit" class="w-full bg-amber-600 text-white font-bold py-3 px-6 rounded-md hover:bg-amber-700 transition duration-300 text-lg">
                        Registrar Movimiento
                    </button>
                </div>
            </form>
        </section>

                <section id="view-historial" class="view space-y-6">
            <p class="text-lg text-amber-800">
                Registro cronológico de movimientos. **Por defecto se muestran solo los movimientos del día actual** para facilitar el traspaso de lote.
            </p>
            
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center bg-white p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-amber-900 mb-2 sm:mb-0">Filtro de Historial</h2>
                <select id="historialFilter" class="p-2 border border-amber-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                    <option value="TODAY">Movimientos de Hoy</option>
                    <option value="ALL">Todos los Movimientos</option>
                </select>
            </div>
            
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                <div class="overflow-x-auto">
                    <table class="w-full min-w-max">
                        <thead class="bg-amber-100">
                            <tr>
                                <th class="p-3 text-left font-semibold text-amber-800">Fecha/Hora</th>
                                <th class="p-3 text-left font-semibold text-amber-800">Producto</th>
                                <th class="p-3 text-left font-semibold text-amber-800">Tipo</th>
                                <th class="p-3 text-left font-semibold text-amber-800">Registro</th>
                                <th class="p-3 text-left font-semibold text-amber-800">Cant. Base</th>
                                <th class="p-3 text-left font-semibold text-amber-800">Operario</th>
                            </tr>
                        </thead>
                        <tbody id="historialTableBody">
                            <tr>
                                <td colspan="6" class="p-4 text-center text-gray-500">Cargando datos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
                <section id="view-configuracion" class
