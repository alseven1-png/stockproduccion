<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panader√≠a Control de Producci√≥n</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // ============================================================
        // 1. CONFIGURACI√ìN DE SEGURIDAD
        // ============================================================
        const CLAVE_ADMIN = "2550LP"; 

        const firebaseConfig = {
  apiKey: "AIzaSyBKV1mVfhFZJgeZRu6FHgz-2_KVrKDlHoc",
  authDomain: "mercaderia-f1699.firebaseapp.com",
  projectId: "mercaderia-f1699",
  storageBucket: "mercaderia-f1699.firebasestorage.app",
  messagingSenderId: "230493635490",
  appId: "1:230493635490:web:f4b780864dbc64eebda8fb"
};
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentUser = null;
        let productosGlobal = [];
        let operariosGlobal = [];
        let movimientosGlobal = []; 
        let isAdminUnlocked = false; 
        
        const COLL_MOVIMIENTOS = "movimientos"; 
        const COLL_CONFIG = "configuracion";

        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => {
            auth.signInAnonymously().catch(e => console.error("Error conexi√≥n: ", e));
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('status-icon').classList.replace('text-red-500', 'text-green-400');
                    inicializarSistema();
                }
            });
            establecerFechaInput();
        });

        async function inicializarSistema() {
            await cargarConfiguracionGeneral();
            escucharMovimientos();
        }

        // --- CONFIGURACI√ìN ---
        
        // LA LISTA COMPLETA DE PRODUCTOS IR√Å AQU√ç
        const PRODUCTOS_DEFAULT = `Media Luna Dulce | Unidad | Lata | 12 | 0
Media Luna Salada | Unidad | Lata | 12 | 0
Surtidas Dulces | Unidad | Bandeja | 6 | 0
Surtidas Saladas | Unidad | Docena | 12 | 0
Vigilantes | Unidad | Docena | 12 | 0
Sacramento | Unidad | Docena | 12 | 0
Palitos Dulces | Unidad | Media Docena | 6 | 0
Pan Franc√©s | Kg | Bolsa | 20 | 0`;

        const OPERARIOS_DEFAULT = "Ma√±ana\nTarde\nNoche";

        async function cargarConfiguracionGeneral() {
            try {
                // Cargar Productos
                const docProd = await db.collection(COLL_CONFIG).doc("productos_lista").get();
                let csvProd = PRODUCTOS_DEFAULT;
                if (docProd.exists) csvProd = docProd.data().csv;
                else await db.collection(COLL_CONFIG).doc("productos_lista").set({ csv: PRODUCTOS_DEFAULT });
                document.getElementById('config-productos').value = csvProd;
                procesarProductosCSV(csvProd);

                // Cargar Operarios
                const docOp = await db.collection(COLL_CONFIG).doc("operarios_lista").get();
                let txtOp = OPERARIOS_DEFAULT;
                if (docOp.exists) txtOp = docOp.data().lista;
                else await db.collection(COLL_CONFIG).doc("operarios_lista").set({ lista: OPERARIOS_DEFAULT });

                document.getElementById('config-operarios').value = txtOp;
                procesarOperarios(txtOp);

            } catch (e) {
                console.error(e);
                procesarProductosCSV(PRODUCTOS_DEFAULT);
                procesarOperarios(OPERARIOS_DEFAULT);
            }
        }

        function procesarProductosCSV(csvText) {
            productosGlobal = csvText.split('\n').map(l => l.trim()).filter(l => l.length > 0).map((l, i) => {
                const p = l.split('|').map(s => s.trim());
                return { 
                    id: 'prod_' + i, nombre: p[0], unidad: p[1] || 'Unidad', alterno: p[2] || '-', factor: parseFloat(p[3]) || 1, stockInicial: parseFloat(p[4]) || 0 
                };
            });
            llenarSelectProductos();
        }

        function procesarOperarios(txt) {
            operariosGlobal = txt.split('\n').map(s => s.trim()).filter(s => s.length > 0);
            llenarSelectOperarios();
        }
        
        function llenarSelectProductos() {
             const sel = document.getElementById('producto');
            const actual = sel.value;
            sel.innerHTML = '<option value="" disabled selected>Seleccione producto...</option>';
            productosGlobal.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id; opt.text = p.nombre; sel.appendChild(opt);
            });
            if(actual) sel.value = actual;
        }

        function llenarSelectOperarios() {
            const sel = document.getElementById('operario');
            const actual = sel.value;
            sel.innerHTML = '';
            operariosGlobal.forEach(op => {
                const opt = document.createElement('option');
                opt.value = op; opt.text = op; sel.appendChild(opt);
            });
            if(actual) sel.value = actual;
        }


        // --- N√öCLEO: C√ÅLCULOS ---

        function escucharMovimientos() {
            db.collection(COLL_MOVIMIENTOS).orderBy("timestamp", "desc").onSnapshot((snapshot) => {
                movimientosGlobal = [];
                snapshot.forEach((doc) => movimientosGlobal.push({ id: doc.id, ...doc.data() }));
                actualizarPanelPrincipal();
                actualizarHistorialVisual(); 
            });
        }
        
        function esEntrada(tipo) { return tipo === 'ENTRADA' || tipo === 'SOBRANTE'; }

        function obtenerFechaLocal() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0,16);
        }

        function esHoy(fechaIsoString) {
             const hoy = obtenerFechaLocal().split('T')[0];
             return fechaIsoString && fechaIsoString.startsWith(hoy);
        }

        function actualizarPanelPrincipal() {
            const stockMap = {};
            productosGlobal.forEach(p => stockMap[p.id] = p.stockInicial);
            
            const produccionDiariaMap = {}; 
            const sobranteDiarioMap = {};
            const produccionHistoricaMap = {}; 

            [...movimientosGlobal].reverse().forEach(m => {
                // Stock General
                if (m.tipo !== 'SALIDA') stockMap[m.productoId] += m.cantidadBase;
                else stockMap[m.productoId] -= Math.abs(m.cantidadBase); 

                // Reconciliaci√≥n Diaria (solo ENTRADA y SOBRANTE de hoy)
                if (esHoy(m.fecha)) {
                    if (m.tipo === 'ENTRADA') {
                        if (!produccionDiariaMap[m.productoId]) produccionDiariaMap[m.productoId] = 0;
                        produccionDiariaMap[m.productoId] += Math.abs(m.cantidadBase);
                    } else if (m.tipo === 'SOBRANTE') {
                         if (!sobranteDiarioMap[m.productoId]) sobranteDiarioMap[m.productoId] = 0;
                         sobranteDiarioMap[m.productoId] += Math.abs(m.cantidadBase);
                    }
                }
                
                // Producci√≥n Hist√≥rica (para el gr√°fico - solo ENTRADA/SOBRANTE)
                 if (m.tipo !== 'SALIDA') {
                    if (!produccionHistoricaMap[m.productoNombre]) produccionHistoricaMap[m.productoNombre] = 0;
                    produccionHistoricaMap[m.productoNombre] += Math.abs(m.cantidadBase);
                }
            });

            // 1. Renderizar Tabla "Reconciliaci√≥n Diaria"
            const tbodyHoy = document.getElementById('tabla-produccion-hoy');
            tbodyHoy.innerHTML = '';
            let hayDatosHoy = false;
            
            productosGlobal.forEach(p => {
                const prod = produccionDiariaMap[p.id] || 0;
                const sob = sobranteDiarioMap[p.id] || 0;
                
                if (prod > 0 || sob > 0) {
                    hayDatosHoy = true;
                    const ventaCalculada = (prod - sob) >= 0 ? (prod - sob) : 0;
                    const colorVenta = ventaCalculada > 0 ? 'text-blue-700' : 'text-gray-500';

                    tbodyHoy.innerHTML += `
                        <tr class="border-b border-green-100">
                            <td class="py-2 font-medium text-gray-800 pl-4">${p.nombre}</td>
                            <td class="py-2 text-center text-green-700">${prod.toFixed(1)} ${p.unidad}</td>
                            <td class="py-2 text-center text-amber-700">${sob.toFixed(1)} ${p.unidad}</td>
                            <td class="py-2 text-center font-bold ${colorVenta}">${ventaCalculada.toFixed(1)} ${p.unidad}</td>
                        </tr>
                    `;
                }
            });
            
            if (!hayDatosHoy) {
                tbodyHoy.innerHTML = '<tr><td colspan="4" class="text-center py-6 text-gray-400 italic">Sin movimientos de Producci√≥n/Sobrante registrados hoy</td></tr>';
            }

            // 2. Renderizar Tarjetas de Stock General (Dep√≥sito)
            const grid = document.getElementById('grid-stock');
            grid.innerHTML = '';
            let alertaStock = 0;

            productosGlobal.forEach(p => {
                const actual = stockMap[p.id] || 0;
                if (actual < 10) alertaStock++;
                
                grid.innerHTML += `
                    <div class="bg-white p-3 rounded shadow border-l-4 ${actual < 10 ? 'border-red-500' : 'border-amber-500'} flex justify-between items-center transition duration-300 hover:shadow-lg">
                        <div class="overflow-hidden">
                            <h3 class="font-bold text-gray-700 truncate text-sm">${p.nombre}</h3>
                            <p class="text-xs text-gray-400">Total Dep√≥sito</p>
                        </div>
                        <div class="text-right">
                            <span class="block text-lg font-bold text-gray-800">${actual.toFixed(1)}</span>
                            <span class="text-xs text-gray-500">${p.unidad}</span>
                        </div>
                    </div>
                `;
            });

            document.getElementById('kpi-alertas').innerText = alertaStock;
            
            // 3. Actualizar Gr√°ficos
            actualizarGraficos(produccionHistoricaMap);
        }

        // --- GR√ÅFICOS ---
        let chartInstance = null;
        function actualizarGraficos(produccionHistoricaMap) {
            const ctx = document.getElementById('graficoProduccion');
            if(!ctx) return;

            const labels = Object.keys(produccionHistoricaMap);
            const data = Object.values(produccionHistoricaMap);

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Hist√≥rico Total',
                        data: data,
                        backgroundColor: ['#f59e0b', '#ef4444', '#3b82f6', '#10b981', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f472b6', '#fb7185'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }
                }
            });
        }


        // --- FUNCIONES INTERFAZ ---

        window.guardarMovimiento = function(e) {
            e.preventDefault();
            if (!currentUser) return alert("Esperando conexi√≥n...");
            
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerText = "Guardando...";

            const prodId = document.getElementById('producto').value;
            const prod = productosGlobal.find(p => p.id === prodId);
            const tipo = document.getElementById('tipo').value; 
            const formato = document.getElementById('formato').value;
            const cantidad = parseFloat(document.getElementById('cantidad').value);
            const operario = document.getElementById('operario').value;
            const fecha = document.getElementById('fecha').value;

            let cantBase = cantidad;
            let formatoTexto = prod.unidad;
            
            if (formato === 'alterno') {
                cantBase = cantidad * prod.factor;
                formatoTexto = prod.alterno; 
            }
            
            let cantBaseCalculo = cantBase;
            if (tipo === 'SALIDA') {
                 cantBaseCalculo = -cantBase;
            }

            db.collection(COLL_MOVIMIENTOS).add({
                productoId: prodId, productoNombre: prod.nombre,
                tipo: tipo, cantidadOriginal: cantidad, formatoUsado: formatoTexto,
                cantidadBase: cantBaseCalculo, operario: operario, fecha: fecha,
                timestamp: new Date().toISOString()
            }).then(() => {
                alert(`Movimiento ${tipo} registrado`);
                e.target.reset();
                establecerFechaInput();
                actualizarFormato(); 
                document.getElementById('operario').value = operario; 
            }).catch((err) => {
                alert("Error: " + err.message);
            }).finally(() => {
                btn.disabled = false;
                btn.innerText = "CONFIRMAR CARGA";
            });
        }

        window.actualizarFormato = function() {
            const p = productosGlobal.find(x => x.id === document.getElementById('producto').value);
            const s = document.getElementById('formato');
            s.innerHTML = '';
            if(p) {
                s.add(new Option(p.unidad, "base"));
                if(p.alterno && p.alterno !== '-' && p.alterno.toLowerCase() !== 'no') {
                    s.add(new Option(`${p.alterno} (x${p.factor} ${p.unidad})`, "alterno"));
                }
            }
        }

        // --- SEGURIDAD Y CONFIGURACI√ìN ---

        function verificarAdmin() {
            if (isAdminUnlocked) return true;
            const pass = prompt("üîí ACCESO RESTRINGIDO\nIngrese la contrase√±a de Administrador:");
            if (pass === CLAVE_ADMIN) {
                isAdminUnlocked = true;
                return true;
            } else {
                alert("Contrase√±a incorrecta.");
                return false;
            }
        }

        window.cambiarVista = function(id) {
            if (id === 'vista-config') {
                if (!verificarAdmin()) return; 
            }

            document.querySelectorAll('.vista').forEach(d => d.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('border-amber-300', 'text-white', 'font-bold');
                b.classList.add('border-transparent', 'text-amber-100');
            });
            const btn = document.getElementById('btn-' + id);
            if(btn) {
                 btn.classList.add('border-amber-300', 'text-white', 'font-bold');
                 btn.classList.remove('border-transparent', 'text-amber-100');
            }
        }

        window.guardarConfiguracion = async function() {
            if (!verificarAdmin()) return; 

            const nuevoProd = document.getElementById('config-productos').value;
            const nuevosOps = document.getElementById('config-operarios').value;
            try {
                await db.collection(COLL_CONFIG).doc("productos_lista").set({ csv: nuevoProd });
                await db.collection(COLL_CONFIG).doc("operarios_lista").set({ lista: nuevosOps });
                
                procesarProductosCSV(nuevoProd);
                procesarOperarios(nuevosOps);
                alert("Configuraci√≥n guardada correctamente.");
            } catch(e) { alert("Error: " + e.message); }
        }

        // RESET DE F√ÅBRICA (Borra movimientos y pone stock en 0)
        window.limpiarBaseDeDatos = async function() {
            const pass = prompt("‚õî ZONA DE PELIGRO ‚õî\n\nPara BORRAR TODO y poner el stock en CERO, ingrese la contrase√±a de Administrador:");
            
            if (pass !== CLAVE_ADMIN) return alert("Contrase√±a incorrecta.");
            
            if (!confirm("¬øEst√°s seguro? Se borrar√°n todos los movimientos hist√≥ricos y el stock volver√° a 0.")) return;

            const snap = await db.collection(COLL_MOVIMIENTOS).get();
            const batch = db.batch();
            snap.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();

            await db.collection(COLL_CONFIG).doc("productos_lista").set({ csv: PRODUCTOS_DEFAULT });
            document.getElementById('config-productos').value = PRODUCTOS_DEFAULT;
            procesarProductosCSV(PRODUCTOS_DEFAULT);

            alert("‚ôªÔ∏è SISTEMA RESTAURADO A CERO.");
        }

        // --- HISTORIAL ---
        let modoHistorial = 'cronologico'; 

        window.toggleModoHistorial = function() {
            modoHistorial = modoHistorial === 'cronologico' ? 'agrupado' : 'cronologico';
            document.getElementById('btn-toggle-historial').innerText = modoHistorial === 'cronologico' ? 'Agrupar por Producto' : 'Ver Cronol√≥gico';
            actualizarHistorialVisual();
        }

        function getColorClase(tipo) {
            if (tipo === 'ENTRADA') return 'text-green-600';
            if (tipo === 'SOBRANTE') return 'text-blue-600'; 
            return 'text-red-600';
        }

        function getSigno(tipo) {
            if (tipo === 'SALIDA') return '-';
            return '+';
        }

        function getAbrev(tipo) {
            if (tipo === 'ENTRADA') return 'PROD';
            if (tipo === 'SALIDA') return 'VENTA';
            return 'SOB';
        }

        function actualizarHistorialVisual() {
            const div = document.getElementById('contenedor-historial');
            div.innerHTML = '';

            if (movimientosGlobal.length === 0) {
                div.innerHTML = '<p class="text-center text-gray-400 p-4">No hay movimientos</p>';
                return;
            }

            if (modoHistorial === 'cronologico') {
                let html = `<table class="w-full text-sm"><thead class="bg-gray-100 text-gray-500"><tr><th class="p-2 text-left">Hora</th><th class="p-2 text-left">Producto</th><th class="p-2 text-center">Tipo</th><th class="p-2 text-right">Cant</th><th class="p-2 text-right">Op</th></tr></thead><tbody>`;
                movimientosGlobal.slice(0, 100).forEach(m => {
                    const hora = m.fecha.slice(11,16);
                    const dia = m.fecha.slice(8,10); 
                    const color = getColorClase(m.tipo);
                    const abrev = getAbrev(m.tipo);
                    html += `<tr class="border-b hover:bg-gray-50">
                        <td class="p-2 text-gray-500 text-xs">${dia} ${hora}</td>
                        <td class="p-2 font-medium">${m.productoNombre}</td>
                        <td class="p-2 text-center text-xs font-bold"><span class="bg-gray-200 px-1 rounded-full text-gray-600">${abrev}</span></td>
                        <td class="p-2 text-right font-bold ${color}">${getSigno(m.tipo)}${Math.abs(m.cantidadOriginal)} ${m.formatoUsado}</td>
                         <td class="p-2 text-right text-xs text-gray-500">${m.operario}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                div.innerHTML = html;

            } else {
                const agrupado = {};
                movimientosGlobal.forEach(m => {
                    if (!agrupado[m.productoNombre]) agrupado[m.productoNombre] = [];
                    agrupado[m.productoNombre].push(m);
                });

                Object.keys(agrupado).sort().forEach(prod => {
                    let itemsHtml = '';
                    agrupado[prod].forEach(m => {
                         const color = getColorClase(m.tipo);
                         itemsHtml += `<div class="flex justify-between text-xs border-b border-gray-100 py-1">
                            <span class="text-gray-500">${m.fecha.slice(8,10)}/${m.fecha.slice(5,7)} ${m.fecha.slice(11,16)} - ${m.operario}</span>
                            <span class="font-bold ${color}">${getSigno(m.tipo)}${Math.abs(m.cantidadOriginal)} ${m.formatoUsado} (${getAbrev(m.tipo)})</span>
                         </div>`;
                    });

                    div.innerHTML += `
                        <div class="bg-white border rounded mb-2 overflow-hidden shadow-sm">
                            <div class="bg-amber-50 p-2 font-bold text-amber-900 flex justify-between">
                                <span>${prod}</span>
                                <span class="text-xs bg-amber-200 px-2 rounded-full pt-1">${agrupado[prod].length} movs</span>
                            </div>
                            <div class="p-2 bg-white">
                                ${itemsHtml}
                            </div>
                        </div>
                    `;
                });
            }
        }

        function establecerFechaInput() {
            const el = document.getElementById('fecha');
            if(el) el.value = obtenerFechaLocal();
        }

    </script>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden text-gray-800 font-sans">

    <header class="bg-amber-700 text-white shadow-md flex-none z-20">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-bread-slice text-2xl text-amber-300"></i>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Panader√≠a Control de Producci√≥n</h1>
                    <p class="text-xs text-amber-300 opacity-80">Gesti√≥n de Stock en Tiempo Real</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <i id="status-icon" class="fas fa-circle text-red-500 text-xs"></i>
            </div>
        </div>
    </header>

    <div class="bg-amber-800 shadow-inner flex-none">
        <div class="container mx-auto flex">
            <button id="btn-vista-panel" onclick="cambiarVista('vista-panel')" class="nav-btn flex-1 py-3 text-center border-b-4 border-amber-300 text-white font-bold text-sm transition border-r border-amber-900/50">
                <i class="fas fa-clipboard-list block mb-1"></i>Resumen
            </button>
            <button id="btn-vista-carga" onclick="cambiarVista('vista-carga')" class="nav-btn flex-1 py-3 text-center border-b-4 border-transparent text-amber-100 font-medium text-sm transition border-r border-amber-900/50">
                <i class="fas fa-plus-circle block mb-1"></i>Cargar
            </button>
            <button id="btn-vista-historial" onclick="cambiarVista('vista-historial')" class="nav-btn flex-1 py-3 text-center border-b-4 border-transparent text-amber-100 font-medium text-sm transition border-r border-amber-900/50">
                <i class="fas fa-history block mb-1"></i>Historial
            </button>
            <button id="btn-vista-config" onclick="cambiarVista('vista-config')" class="nav-btn flex-1 py-3 text-center border-b-4 border-transparent text-amber-100 font-medium text-sm transition">
                <i class="fas fa-lock block mb-1"></i>Config
            </button>
        </div>
    </div>

    <main class="flex-1 overflow-y-auto bg-gray-50 p-4 pb-20">

        <div id="vista-panel" class="vista container mx-auto max-w-5xl space-y-4">
            
            <div class="bg-white rounded-lg shadow-md border-t-4 border-green-500 overflow-hidden">
                <div class="bg-green-50 px-4 py-3 border-b border-green-100 flex justify-between items-center">
                    <div>
                        <h2 class="font-bold text-green-900 text-lg">Reconciliaci√≥n Diaria</h2>
                        <p class="text-xs text-green-700">Diferencia a validar con el sistema de facturaci√≥n</p>
                    </div>
                    <i class="fas fa-calculator text-green-300 text-2xl"></i>
                </div>
                <div class="p-0 overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                            <tr>
                                <th class="text-left py-2 pl-4">Producto</th>
                                <th class="text-center py-2">Prod. (A)</th>
                                <th class="text-center py-2">Sob. (B)</th>
                                <th class="text-center py-2 font-bold text-blue-700">Venta Esp. (A-B)</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-produccion-hoy" class="divide-y divide-gray-100">
                            <tr><td colspan="4" class="text-center py-4 text-gray-400">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-white p-3 rounded-lg shadow h-64 border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-1 text-sm">Distribuci√≥n Hist√≥rica (Producci√≥n/Sobrante)</h3>
                <div class="h-56 relative">
                    <canvas id="graficoProduccion"></canvas>
                </div>
            </div>

            <div class="flex justify-between items-center mt-6 mb-2">
                <h3 class="font-bold text-gray-700 text-sm">Stock General (Dep√≥sito)</h3>
                <span class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded-full"><span id="kpi-alertas">0</span> Bajos</span>
            </div>
            <div id="grid-stock" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                </div>
        </div>

        <div id="vista-carga" class="vista hidden container mx-auto max-w-md">
            <div class="bg-white p-5 rounded-lg shadow-lg border-t-4 border-amber-500 space-y-5">
                <h2 class="text-lg font-bold text-gray-800 text-center border-b pb-2">Nueva Carga</h2>
                
                <form onsubmit="guardarMovimiento(event)" class="space-y-4">
                    <div>
                        <label class="lbl">Producto</label>
                        <select id="producto" onchange="actualizarFormato()" required class="input-field w-full bg-gray-50"></select>
                    </div>

                    <div class="flex gap-3">
                        <div class="w-1/2">
                            <label class="lbl">Acci√≥n</label>
                            <select id="tipo" class="input-field w-full font-bold">
                                <option value="ENTRADA">PRODUCCI√ìN (+)</option>
                                <option value="SOBRANTE">SOBRANTE (+)</option>
                                <option value="SALIDA">VENTA/MERMA (-)</option>
                            </select>
                        </div>
                        <div class="w-1/2">
                            <label class="lbl">Formato</label>
                            <select id="formato" class="input-field w-full bg-amber-50 border-amber-200 text-amber-900"><option value="base">Base</option></select>
                        </div>
                    </div>

                    <div>
                        <label class="lbl">Cantidad</label>
                        <input type="number" id="cantidad" step="0.01" required class="input-field w-full text-center text-3xl font-bold text-amber-600 py-3" placeholder="0">
                    </div>

                    <div class="flex gap-3">
                        <div class="w-1/2">
                            <label class="lbl">Operario</label>
                            <select id="operario" class="input-field w-full"></select>
                        </div>
                        <div class="w-1/2">
                            <label class="lbl">Fecha</label>
                            <input type="datetime-local" id="fecha" required class="input-field w-full text-xs">
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-amber-600 text-white py-4 rounded-lg font-bold shadow-lg hover:bg-amber-700 transition active:scale-95 mt-2">
                        CONFIRMAR CARGA
                    </button>
                </form>
            </div>
        </div>

        <div id="vista-historial" class="vista hidden container mx-auto max-w-4xl">
            <div class="flex justify-end mb-2">
                <button id="btn-toggle-historial" onclick="toggleModoHistorial()" class="bg-white border border-gray-300 text-gray-600 px-3 py-1 rounded text-xs font-bold shadow-sm hover:bg-gray-50">
                    <i class="fas fa-layer-group mr-1"></i> Agrupar por Producto
                </button>
            </div>
            <div id="contenedor-historial" class="space-y-2">
                </div>
        </div>

        <div id="vista-config" class="vista hidden container mx-auto max-w-lg space-y-6">
            
            <div class="bg-blue-50 border border-blue-200 p-3 rounded text-center text-blue-800 text-sm font-bold mb-4">
                <i class="fas fa-user-shield mr-2"></i> Modo Administrador Activo
            </div>

            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-400">
                <h3 class="font-bold text-gray-800 mb-1 text-sm">1. Editar Operarios</h3>
                <p class="text-xs text-gray-400 mb-2">Un nombre por l√≠nea</p>
                <textarea id="config-operarios" class="w-full border p-2 text-sm h-24 rounded bg-gray-50"></textarea>
            </div>

            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-purple-400">
                <h3 class="font-bold text-gray-800 mb-1 text-sm">2. Editar Productos (CSV)</h3>
                <p class="text-xs text-gray-400 mb-2">Formato: Nombre | Unidad | Alterno(Lata) | Factor | Stock</p>
                <textarea id="config-productos" class="w-full border p-2 text-xs font-mono h-40 rounded bg-gray-50"></textarea>
            </div>

            <button onclick="guardarConfiguracion()" class="w-full bg-blue-600 text-white py-3 rounded font-bold text-sm shadow hover:bg-blue-700">
                <i class="fas fa-save mr-2"></i>GUARDAR TODOS LOS CAMBIOS
            </button>

            <div class="pt-8 border-t mt-8">
                <h4 class="font-bold text-red-700 mb-2 text-xs uppercase">Zona de Peligro</h4>
                <button onclick="limpiarBaseDeDatos()" class="w-full bg-red-100 text-red-600 py-3 rounded border border-red-200 text-xs font-bold hover:bg-red-200">
                    <i class="fas fa-trash mr-2"></i>RESETEO DE F√ÅBRICA (Borrar Todo)
                </button>
                <p class="text-center text-xs text-gray-400 mt-2">Esto borrar√° historial y pondr√° stock en 0.</p>
            </div>
        </div>

    </main>

    <style>
        .lbl { display: block; font-size: 0.7rem; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 2px; }
        .input-field { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: #d97706; box-shadow: 0 0 0 2px rgba(217, 119, 6, 0.2); }
    </style>
</body>
</html>
