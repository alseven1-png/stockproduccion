<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Mercadería - Panadería</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script type="module">
        // 1. Importamos las funciones necesarias
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, onSnapshot, doc, setDoc, getDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
// Import the functions you need from the SDKs you need


// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBKV1mVfhFZJgeZRu6FHgz-2_KVrKDlHoc",
  authDomain: "mercaderia-f1699.firebaseapp.com",
  projectId: "mercaderia-f1699",
  storageBucket: "mercaderia-f1699.firebasestorage.app",
  messagingSenderId: "230493635490",
  appId: "1:230493635490:web:f4b780864dbc64eebda8fb"
};

// Initialize Firebase

       

        // ==========================================
        // FIN DE LA CONFIGURACIÓN
        // ==========================================

        // Inicializamos la App
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Variables globales para la app
        let currentUser = null;
        let productosGlobal = [];
        
        // Referencias a colecciones
        // Usamos una estructura simple sin appId dinámico para evitar errores de ruta
        const COLL_MOVIMIENTOS = "movimientos"; 
        const COLL_CONFIG = "configuracion";

        // Autenticación Anónima
        signInAnonymously(auth).then(() => {
            console.log("Autenticado anónimamente");
        }).catch((error) => {
            console.error("Error auth:", error);
            alert("Error de conexión con la base de datos: " + error.message);
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('status-con').innerHTML = '<span class="text-green-500"><i class="fas fa-wifi"></i> Conectado</span>';
                cargarDatosIniciales();
                escucharMovimientos();
            } else {
                document.getElementById('status-con').innerHTML = '<span class="text-red-500"><i class="fas fa-times"></i> Desconectado</span>';
            }
        });

        // --- FUNCIONES DE LÓGICA ---

        async function cargarDatosIniciales() {
            // Intentar cargar configuración de productos desde Firebase
            try {
                const docRef = doc(db, COLL_CONFIG, "productos_lista");
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    procesarProductosCSV(docSnap.data().csv);
                } else {
                    // Si no existe, usamos la lista por defecto
                    procesarProductosCSV(PRODUCTOS_DEFAULT);
                    // Y la guardamos para la próxima
                    await setDoc(docRef, { csv: PRODUCTOS_DEFAULT });
                }
                llenarSelectProductos();
            } catch (e) {
                console.error("Error cargando config:", e);
                // Fallback si falla la red
                procesarProductosCSV(PRODUCTOS_DEFAULT);
                llenarSelectProductos();
            }
        }

        function procesarProductosCSV(csvText) {
            productosGlobal = csvText.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map((line, index) => {
                    const parts = line.split('|').map(p => p.trim());
                    return {
                        id: 'prod_' + index,
                        nombre: parts[0],
                        unidad: parts[1] || 'Unidad',
                        alterno: parts[2] || '-',
                        factor: parseFloat(parts[3]) || 1,
                        stockInicial: parseFloat(parts[4]) || 0
                    };
                });
        }

        function llenarSelectProductos() {
            const sel = document.getElementById('producto');
            sel.innerHTML = '<option value="" disabled selected>Seleccione producto...</option>';
            productosGlobal.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.text = p.nombre;
                sel.appendChild(opt);
            });
        }

        // Escuchar cambios en tiempo real
        function escucharMovimientos() {
            const q = query(collection(db, COLL_MOVIMIENTOS), orderBy("timestamp", "desc"), limit(50));
            
            onSnapshot(q, (snapshot) => {
                const movimientos = [];
                snapshot.forEach((doc) => {
                    movimientos.push({ id: doc.id, ...doc.data() });
                });
                actualizarTablaHistorial(movimientos);
                actualizarStockVisual(movimientos);
            });
        }

        // Funciones de Interfaz
        window.cambiarVista = function(vistaId) {
            document.querySelectorAll('.vista').forEach(v => v.classList.add('hidden'));
            document.getElementById(vistaId).classList.remove('hidden');
            
            // Actualizar botones nav
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-amber-700'));
            const activeBtn = document.querySelector(`button[onclick="cambiarVista('${vistaId}')"]`);
            if(activeBtn) activeBtn.classList.add('bg-amber-700');
        }

        window.actualizarFormato = function() {
            const prodId = document.getElementById('producto').value;
            const prod = productosGlobal.find(p => p.id === prodId);
            const selFmt = document.getElementById('formato');
            selFmt.innerHTML = '';
            
            if (prod) {
                // Opción base
                let opt1 = document.createElement('option');
                opt1.value = 'base';
                opt1.text = prod.unidad;
                selFmt.appendChild(opt1);
                
                // Opción alterna si existe
                if (prod.alterno !== '-' && prod.alterno !== '') {
                    let opt2 = document.createElement('option');
                    opt2.value = 'alterno';
                    opt2.text = `${prod.alterno} (x${prod.factor})`;
                    selFmt.appendChild(opt2);
                }
            }
        }

        window.guardarMovimiento = async function(e) {
            e.preventDefault();
            if (!currentUser) { alert("No estás conectado"); return; }

            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            try {
                const prodId = document.getElementById('producto').value;
                const prod = productosGlobal.find(p => p.id === prodId);
                const tipo = document.getElementById('tipo').value;
                const formato = document.getElementById('formato').value;
                let cantidad = parseFloat(document.getElementById('cantidad').value);
                const operario = document.getElementById('operario').value;
                const fechaInput = document.getElementById('fecha').value;

                // Convertir a unidad base para cálculos
                let cantidadBase = cantidad;
                if (formato === 'alterno') {
                    cantidadBase = cantidad * prod.factor;
                }

                // Guardar en Firebase
                await addDoc(collection(db, COLL_MOVIMIENTOS), {
                    productoId: prodId,
                    productoNombre: prod.nombre,
                    tipo: tipo, // ENTRADA o SALIDA
                    cantidadOriginal: cantidad,
                    formatoUsado: formato === 'base' ? prod.unidad : prod.alterno,
                    cantidadBase: cantidadBase,
                    operario: operario,
                    fecha: fechaInput, // Fecha manual
                    timestamp: new Date(), // Fecha sistema para orden
                    usuario: currentUser.uid
                });

                alert("Movimiento registrado con éxito");
                e.target.reset();
                // Reset fecha a hoy
                establecerFechaHoy();
                
            } catch (error) {
                console.error(error);
                alert("Error al guardar: " + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Registrar Movimiento';
            }
        }

        function actualizarTablaHistorial(movs) {
            const tbody = document.getElementById('tabla-body');
            tbody.innerHTML = '';
            
            if (movs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No hay movimientos registrados</td></tr>';
                return;
            }

            movs.forEach(m => {
                const color = m.tipo === 'ENTRADA' ? 'text-green-600' : 'text-red-600';
                const signo = m.tipo === 'ENTRADA' ? '+' : '-';
                const row = `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3">${new Date(m.fecha).toLocaleDateString()}</td>
                        <td class="p-3 font-medium">${m.productoNombre}</td>
                        <td class="p-3"><span class="text-xs font-bold px-2 py-1 rounded ${m.tipo === 'ENTRADA' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${m.tipo}</span></td>
                        <td class="p-3 ${color} font-bold">${signo}${m.cantidadOriginal} ${m.formatoUsado}</td>
                        <td class="p-3 text-gray-500 text-sm">${m.operario}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function actualizarStockVisual(movs) {
            // Calculamos stock en memoria
            const stockMap = {};
            
            // 1. Inicializar con stock base
            productosGlobal.forEach(p => {
                stockMap[p.id] = p.stockInicial;
            });

            // 2. Aplicar movimientos
            // Recorremos en orden cronológico inverso (del más viejo al más nuevo) para calcular bien
            // Pero como movs viene ordenado por 'desc', lo recorremos al revés
            [...movs].reverse().forEach(m => {
                if (!stockMap[m.productoId]) stockMap[m.productoId] = 0;
                if (m.tipo === 'ENTRADA') {
                    stockMap[m.productoId] += m.cantidadBase;
                } else {
                    stockMap[m.productoId] -= m.cantidadBase;
                }
            });

            // 3. Renderizar tarjetas
            const grid = document.getElementById('grid-stock');
            grid.innerHTML = '';
            
            productosGlobal.forEach(p => {
                const stockActual = stockMap[p.id] || 0;
                const esBajo = stockActual < 10; // Alerta si hay menos de 10
                
                const card = `
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 ${esBajo ? 'border-red-500' : 'border-green-500'}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">${p.nombre}</h3>
                                <p class="text-sm text-gray-500">Unidad: ${p.unidad}</p>
                            </div>
                            <div class="text-right">
                                <span class="block text-2xl font-bold ${esBajo ? 'text-red-600' : 'text-gray-800'}">${stockActual.toFixed(1)}</span>
                                ${p.alterno !== '-' ? `<span class="text-xs text-gray-400">aprox ${(stockActual/p.factor).toFixed(1)} ${p.alterno}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                grid.innerHTML += card;
            });
        }

        function establecerFechaHoy() {
            const now = new Date();
            // Ajuste para zona horaria local
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('fecha').value = now.toISOString().slice(0,16);
        }

        // Datos por defecto (Backup)
        const PRODUCTOS_DEFAULT = `
Media Luna Dulce | Unidad | Docena | 12 | 100
Media Luna Salada | Unidad | Docena | 12 | 100
Pan Frances | Kg | Bolsa | 20 | 50
Bizcochos | Kg | - | 1 | 20
Tortitas Negras | Unidad | Docena | 12 | 60
Vigilantes | Unidad | Docena | 12 | 60
Cañoncitos | Unidad | Bandeja | 6 | 40
`;

        // Inicialización al cargar DOM
        window.addEventListener('DOMContentLoaded', () => {
            establecerFechaHoy();
        });

    </script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <header class="bg-amber-600 text-white shadow-md z-10 flex-none">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-bread-slice text-2xl"></i>
                <h1 class="text-xl font-bold tracking-wide">Control Panadería</h1>
            </div>
            <div id="status-con" class="text-sm bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm">
                Conectando...
            </div>
        </div>
    </header>

    <nav class="bg-amber-800 text-amber-100 flex-none">
        <div class="container mx-auto flex">
            <button onclick="cambiarVista('vista-panel')" class="nav-btn flex-1 py-3 text-center hover:bg-amber-700 transition font-medium bg-amber-700 border-b-4 border-amber-500">
                <i class="fas fa-th-large mr-2"></i>Stock Actual
            </button>
            <button onclick="cambiarVista('vista-carga')" class="nav-btn flex-1 py-3 text-center hover:bg-amber-700 transition font-medium">
                <i class="fas fa-plus-circle mr-2"></i>Registrar
            </button>
            <button onclick="cambiarVista('vista-historial')" class="nav-btn flex-1 py-3 text-center hover:bg-amber-700 transition font-medium">
                <i class="fas fa-history mr-2"></i>Historial
            </button>
        </div>
    </nav>

    <main class="flex-1 overflow-y-auto p-4 md:p-6">
        
        <div id="vista-panel" class="vista container mx-auto max-w-5xl">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2">Estado del Stock</h2>
            <div id="grid-stock" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="col-span-full text-center py-10 text-gray-400">
                    <i class="fas fa-circle-notch fa-spin text-3xl mb-3"></i>
                    <p>Cargando datos del inventario...</p>
                </div>
            </div>
        </div>

        <div id="vista-carga" class="vista hidden container mx-auto max-w-xl">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">Nuevo Movimiento</h2>
                
                <form onsubmit="guardarMovimiento(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Producto</label>
                        <select id="producto" onchange="actualizarFormato()" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none bg-gray-50">
                            <option>Cargando lista...</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Acción</label>
                            <select id="tipo" required class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                                <option value="ENTRADA">Producción (Entrada)</option>
                                <option value="SALIDA">Venta/Salida</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Unidad Medida</label>
                            <select id="formato" required class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                                <option value="base">Unidad Base</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
                        <input type="number" id="cantidad" step="0.01" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 text-lg font-bold text-center">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Responsable</label>
                            <select id="operario" required class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                                <option>Mañana</option>
                                <option>Tarde</option>
                                <option>Noche</option>
                                <option>Mostrador</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha/Hora</label>
                            <input type="datetime-local" id="fecha" required class="w-full p-3 border border-gray-300 rounded-lg text-sm">
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-4 rounded-lg shadow-md transition transform active:scale-95 mt-4">
                        Registrar Movimiento
                    </button>
                </form>
            </div>
        </div>

        <div id="vista-historial" class="vista hidden container mx-auto max-w-4xl">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2">Últimos Movimientos</h2>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full whitespace-nowrap">
                        <thead class="bg-gray-100 text-gray-600 text-left text-sm uppercase">
                            <tr>
                                <th class="p-3">Fecha</th>
                                <th class="p-3">Producto</th>
                                <th class="p-3">Tipo</th>
                                <th class="p-3">Cantidad</th>
                                <th class="p-3">Resp.</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body" class="divide-y divide-gray-200 text-sm text-gray-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

</body>
</html>
