<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Producción y Stock</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // ============================================================
        // 1. CONFIGURACIÓN
        // ============================================================
        const CLAVE_ADMIN = "2550LP"; 
        
        const firebaseConfig = {
            apiKey: "AIzaSyBKV1mVfhFZJgeZRu6FHgz-2_KVrKDlHoc",
            authDomain: "mercaderia-f1699.firebaseapp.com",
            projectId: "mercaderia-f1699",
            storageBucket: "mercaderia-f1699.firebasestorage.app",
            messagingSenderId: "230493635490",
            appId: "1:230493635490:web:f4b780864dbc64eebda8fb"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // VARIABLES GLOBALES
        let currentUser = null;
        let productosGlobal = []; 
        let operariosGlobal = [];
        let movimientosGlobal = []; 
        let isAdminUnlocked = false; 
        let modoHistorial = 'cronologico'; // 'cronologico' o 'agrupado'
        
        const COLL_MOVIMIENTOS = "movimientos"; 
        const COLL_CONFIG = "configuracion";
        // Orden de categorías para respetar la carga
        const ORDEN_CATEGORIAS = ['panaderia', 'pasteleria', 'cocina'];
        const CATEGORIAS_NOMBRES = { panaderia: 'Panadería', pasteleria: 'Pastelería', cocina: 'Cocina' };
        
        // --- UTILIDADES DE FECHA ---
        
        function obtenerFechaLocal() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0,16);
        }

        function obtenerFechaHoyYMD() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0,10);
        }

        function establecerInputs() {
            const el = document.getElementById('fecha');
            if(el) el.value = obtenerFechaLocal();
            
            const filtroPanel = document.getElementById('filtro-fecha-panel');
            if(filtroPanel && !filtroPanel.value) filtroPanel.value = obtenerFechaHoyYMD();
        }

        // --- GESTIÓN DE CSV Y PRODUCTOS ---
        
        function getProductDefault(key) {
             if (key === 'panaderia') return `Media Luna Dulce | Unidad | Docena | 12 | 0\nMedia Luna Salada | Unidad | Docena | 12 | 0\nFactura Rellena | Unidad | Docena | 12 | 0\nPan Francés | Kg | Unidad | 0.5 | 0\nPan Rallado | Kg | - | 1 | 0\nLibritos | Kg | Docena | 0.3 | 0`;
             if (key === 'pasteleria') return `Tarta Frutal | Unidad | Porción | 6 | 0\nAlfajor de Maicena | Unidad | Bandeja | 10 | 0`;
             if (key === 'cocina') return `Prepizza Tomate | Unidad | Pack | 3 | 0\nPizza Lista | Unidad | - | 1 | 0`;
            return '';
        }
        
        function procesarProductosCSV(csvText, categoria) {
            return csvText.split('\n').map(l => l.trim()).filter(l => l.length > 0).map((l, i) => {
                const p = l.split('|').map(s => s.trim());
                // Usamos el índice 'i' para garantizar que se respete el orden de la lista
                return { 
                    id: `${categoria}_${String(i).padStart(3, '0')}`, 
                    categoria: categoria,
                    nombre: p[0], 
                    unidad: p[1] || 'Unidad', 
                    alterno: p[2] || '-', 
                    factor: parseFloat(p[3]) || 1, 
                    stockInicial: parseFloat(p[4]) || 0 
                };
            });
        }

        // --- CARGA INICIAL DE DATOS ---

        async function cargarConfiguracionGeneral() {
            try {
                productosGlobal = [];
                // Carga secuencial para respetar el orden estricto de las familias
                for (const key of ORDEN_CATEGORIAS) {
                    const docRef = db.collection(COLL_CONFIG).doc(`productos_${key}`);
                    const docSnap = await docRef.get();
                    
                    let csv = getProductDefault(key);
                    if (docSnap.exists) csv = docSnap.data().csv;
                    else await docRef.set({ csv: csv });
                    
                    const configEl = document.getElementById(`config-${key}`);
                    if(configEl) configEl.value = csv;
                    
                    productosGlobal.push(...procesarProductosCSV(csv, key));
                }

                // Cargar Operarios
                const docOp = await db.collection(COLL_CONFIG).doc("operarios_lista").get();
                let txtOp = "Mañana\nTarde\nNoche";
                if (docOp.exists) txtOp = docOp.data().lista;
                else await db.collection(COLL_CONFIG).doc("operarios_lista").set({ lista: txtOp });

                const opEl = document.getElementById('config-operarios');
                if(opEl) opEl.value = txtOp; 
                
                operariosGlobal = txtOp.split('\n').map(s => s.trim()).filter(s => s.length > 0);
                llenarSelectOperarios();

            } catch (e) {
                console.error("Error al cargar config:", e);
                alert("Error de conexión al cargar configuración.");
            }
        }

        function llenarSelectOperarios() {
            const sel = document.getElementById('operario');
            if(!sel) return;
            const actual = sel.value;
            sel.innerHTML = '';
            operariosGlobal.forEach(op => {
                const opt = document.createElement('option');
                opt.value = op; opt.text = op; sel.appendChild(opt);
            });
            if(actual) sel.value = actual;
        }

        // --- ESCUCHA DE MOVIMIENTOS ---

        function escucharMovimientos() {
            db.collection(COLL_MOVIMIENTOS).orderBy("timestamp", "desc").onSnapshot((snapshot) => {
                movimientosGlobal = [];
                snapshot.forEach((doc) => movimientosGlobal.push({ id: doc.id, ...doc.data() }));
                actualizarPanelPrincipal();
                actualizarHistorialVisual(); 
            });
        }

        // ============================================================
        // 2. LÓGICA PRINCIPAL (CÁLCULOS Y DASHBOARD)
        // ============================================================

        window.actualizarPanelPrincipal = function() {
            const filtroFechaInput = document.getElementById('filtro-fecha-panel');
            const fechaSeleccionada = filtroFechaInput ? filtroFechaInput.value : obtenerFechaHoyYMD();

            // Maps para acumular datos
            const stockMap = {}; // Stock histórico acumulado (Real)
            productosGlobal.forEach(p => stockMap[p.id] = p.stockInicial);
            
            // Datos del día seleccionado
            const produccionDia = {};
            const descarteDia = {};
            const reutilizacionDia = {};
            
            let totalProd = 0;
            let totalDesc = 0;
            let totalReut = 0;

            // Procesamos movimientos (reverse para calcular stock cronológicamente)
            [...movimientosGlobal].reverse().forEach(m => {
                // 1. STOCK REAL (Siempre se calcula todo)
                // ENTRADA suma, todo lo demás resta
                if(m.tipo === 'ENTRADA') stockMap[m.productoId] += Math.abs(m.cantidadBase);
                else stockMap[m.productoId] -= Math.abs(m.cantidadBase);

                // 2. REPORTE DEL DÍA (Solo si coincide la fecha)
                if (m.fecha.startsWith(fechaSeleccionada)) {
                    const cant = Math.abs(m.cantidadBase);
                    
                    if (m.tipo === 'ENTRADA') { 
                        produccionDia[m.productoId] = (produccionDia[m.productoId] || 0) + cant;
                        totalProd += cant;
                    } 
                    else if (m.tipo === 'DESCARTE') { 
                        descarteDia[m.productoId] = (descarteDia[m.productoId] || 0) + cant;
                        totalDesc += cant;
                    }
                    else if (m.tipo === 'REUTILIZACION') { 
                        reutilizacionDia[m.productoId] = (reutilizacionDia[m.productoId] || 0) + cant;
                        totalReut += cant;
                    }
                    // 'SALIDA' (Venta manual) no la sumamos a los KPIs de producción/merma, pero sí afecta el stock.
                }
            });

            // --- ACTUALIZAR UI ---

            // A. Fecha en título
            const [yyyy, mm, dd] = fechaSeleccionada.split('-');
            const labelFecha = document.getElementById('label-fecha-tabla');
            if(labelFecha) labelFecha.innerText = `${dd}/${mm}/${yyyy}`;

            // B. KPIs Superiores
            document.getElementById('kpi-prod-total').innerText = totalProd.toFixed(0);
            document.getElementById('kpi-descarte-total').innerText = totalDesc.toFixed(0);
            
            // Cálculo de porcentaje de pérdida (Descarte sobre Producción)
            let porcentaje = 0;
            if(totalProd > 0) porcentaje = (totalDesc / totalProd) * 100;
            
            const kpiPorc = document.getElementById('kpi-porcentaje-merma');
            kpiPorc.innerText = porcentaje.toFixed(1) + '%';
            // Colores semáforo para el KPI
            kpiPorc.className = "text-xl font-bold " + (porcentaje > 15 ? "text-red-600" : (porcentaje > 5 ? "text-amber-600" : "text-green-600"));

            // C. Tabla Detallada (Iteramos productosGlobal para respetar ORDEN DE CONFIGURACIÓN)
            const tbody = document.getElementById('tabla-produccion-hoy');
            if (tbody) {
                tbody.innerHTML = '';
                let hayDatos = false;
                
                productosGlobal.forEach(p => {
                    const prod = produccionDia[p.id] || 0;
                    const desc = descarteDia[p.id] || 0;
                    const reut = reutilizacionDia[p.id] || 0;
                    
                    // Solo mostramos si hubo movimiento hoy
                    if (prod > 0 || desc > 0 || reut > 0) {
                        hayDatos = true;
                        // Cálculo Venta Estimada = Prod - Reutilizado - Tirado
                        // Si da negativo (porque vendí stock viejo), mostramos el número real igual.
                        const ventaEst = prod - reut - desc;
                        
                        tbody.innerHTML += `
                            <tr class="border-b border-gray-100 hover:bg-gray-50 text-xs sm:text-sm">
                                <td class="py-2 pl-3 font-medium text-gray-800">${p.nombre}</td>
                                <td class="py-2 text-center font-bold text-green-600 border-l">${prod > 0 ? prod.toFixed(1) : '-'}</td>
                                <td class="py-2 text-center font-bold text-orange-500 border-l">${reut > 0 ? reut.toFixed(1) : '-'}</td>
                                <td class="py-2 text-center font-bold text-red-600 border-l bg-red-50">${desc > 0 ? desc.toFixed(1) : '-'}</td>
                                <td class="py-2 text-center font-bold text-blue-700 border-l">${ventaEst.toFixed(1)} <span class="text-[10px] text-gray-400 font-normal">${p.unidad}</span></td>
                            </tr>
                        `;
                    }
                });

                if (!hayDatos) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-6 text-gray-400 italic text-xs">Sin movimientos en esta fecha</td></tr>';
                }
            }

            // D. Tarjetas de Stock Actual (Siempre visibles, ordenadas por Configuración)
            const grid = document.getElementById('grid-stock');
            if (grid) {
                grid.innerHTML = '';
                productosGlobal.forEach(p => {
                    const actual = stockMap[p.id] || 0;
                    // Filtro visual opcional: Mostrar solo si hay stock o si es negativo
                    // O mostrar todo. Mostraremos todo para facilitar control.
                    const borde = actual < 0 ? 'border-red-500' : (actual < 5 ? 'border-amber-400' : 'border-gray-200');
                    
                    grid.innerHTML += `
                        <div class="bg-white p-2 rounded border-l-4 ${borde} shadow-sm flex justify-between items-center">
                            <div class="overflow-hidden pr-2">
                                <h4 class="font-bold text-gray-700 text-xs truncate" title="${p.nombre}">${p.nombre}</h4>
                                <span class="text-[9px] text-gray-400 uppercase tracking-wider">${CATEGORIAS_NOMBRES[p.categoria]}</span>
                            </div>
                            <div class="text-right">
                                <span class="block text-sm font-bold ${actual < 0 ? 'text-red-600' : 'text-gray-800'}">${actual.toFixed(1)}</span>
                                <span class="text-[9px] text-gray-500">${p.unidad}</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            // E. Gráfico
            actualizarGraficos(produccionDia, productosGlobal);
        }
        
        let chartInstance = null;
        function actualizarGraficos(dataMap, productos) {
            const canvas = document.getElementById('graficoProduccion');
            if (!canvas) return;
            
            const labels = [];
            const dataValues = [];
            
            // Respetamos orden de productos para los colores del gráfico
            productos.forEach(p => {
                if(dataMap[p.id] > 0) {
                    labels.push(p.nombre);
                    dataValues.push(dataMap[p.id]);
                }
            });

            if (chartInstance) { chartInstance.destroy(); }
            if (dataValues.length === 0) return;

            chartInstance = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 8, font: { size: 9 } } } }
                }
            });
        }

        // ============================================================
        // 3. REGISTRO DE MOVIMIENTOS (CARGA)
        // ============================================================

        window.guardarMovimiento = function(e) {
            e.preventDefault();
            if (!currentUser) return alert("Esperando conexión...");
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.innerText = "Guardando...";

            const prodId = document.getElementById('producto').value;
            const prod = productosGlobal.find(p => p.id === prodId);
            const tipo = document.getElementById('tipo').value; 
            const formato = document.getElementById('formato').value;
            const cantidad = parseFloat(document.getElementById('cantidad').value);
            const operario = document.getElementById('operario').value;
            const fecha = document.getElementById('fecha').value;

            if(!prod) { btn.disabled=false; btn.innerText="CONFIRMAR"; return alert("Producto no válido."); }
            if(isNaN(cantidad) || cantidad <= 0) { btn.disabled=false; btn.innerText="CONFIRMAR"; return alert("Cantidad inválida."); }

            // Lógica de Unidades
            let cantBase = cantidad;
            let formatoTexto = 'Unidad';
            if (formato === 'manual_docena') { cantBase = cantidad * 12; formatoTexto = 'Docena'; }
            else if (formato === 'manual_kg') { cantBase = cantidad; formatoTexto = 'Kg'; }
            else if (formato === 'alterno') { cantBase = cantidad * prod.factor; formatoTexto = prod.alterno; }

            // Lógica de Signo para Stock
            // ENTRADA (+), el resto (REUTILIZACION, DESCARTE, SALIDA) son restas (-)
            let cantBaseCalculo = (tipo === 'ENTRADA') ? cantBase : -Math.abs(cantBase);

            db.collection(COLL_MOVIMIENTOS).add({
                productoId: prodId, 
                productoNombre: prod.nombre,
                tipo: tipo, 
                cantidadOriginal: cantidad, 
                formatoUsado: formatoTexto,
                cantidadBase: cantBaseCalculo, 
                operario: operario, 
                fecha: fecha,
                timestamp: new Date().toISOString()
            }).then(() => {
                // Notificación Toast
                mostrarToast("Movimiento registrado correctamente");
                e.target.reset();
                establecerInputs();
                actualizarFormato(); 
                document.getElementById('operario').value = operario; 
            }).catch((err) => {
                alert("Error: " + err.message);
            }).finally(() => {
                btn.disabled = false; btn.innerText = "CONFIRMAR CARGA";
            });
        }
        
        function mostrarToast(msg) {
            const toast = document.createElement('div');
            toast.className = "fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded shadow-lg z-50 text-sm";
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        // --- INTERFAZ DINÁMICA DE CARGA ---
        
        window.filtrarProductos = function(categoria) {
            const sel = document.getElementById('producto');
            if (!sel) return;
            sel.innerHTML = '<option value="" disabled selected>Seleccione producto...</option>';
            
            // Filtramos manteniendo el orden global
            const filtrados = productosGlobal.filter(p => p.categoria === categoria);

            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('bg-amber-600', 'text-white', 'shadow-md'));
            const btn = document.getElementById(`btn-cat-${categoria}`);
            if (btn) btn.classList.add('bg-amber-600', 'text-white', 'shadow-md');

            filtrados.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id; opt.text = p.nombre; sel.appendChild(opt);
            });
            actualizarFormato();
        }
        
        window.actualizarFormato = function() {
            const p = productosGlobal.find(x => x.id === document.getElementById('producto').value);
            const s = document.getElementById('formato');
            const tipo = document.getElementById('tipo');
            if (!s) return;
            s.innerHTML = '';
            
            // Color coding para el select de tipo
            if(tipo) {
                tipo.className = "input-field w-full font-bold border-2 text-sm ";
                if(tipo.value === 'ENTRADA') tipo.classList.add('border-green-500', 'text-green-700');
                else if(tipo.value === 'DESCARTE') tipo.classList.add('border-red-500', 'text-red-700');
                else if(tipo.value === 'REUTILIZACION') tipo.classList.add('border-orange-400', 'text-orange-700');
                else tipo.classList.add('border-blue-500', 'text-blue-700');
            }

            if(p) {
                s.add(new Option("Unidad", "manual_unidad"));
                s.add(new Option("Docena", "manual_docena"));
                s.add(new Option("Kilogramo (Kg)", "manual_kg"));
                
                const isStandard = ['Docena', 'Kg', 'Unidad'].includes(p.alterno); 
                if(p.alterno && p.alterno !== '-' && !isStandard) {
                    s.add(new Option(`${p.alterno} (x${p.factor} ${p.unidad})`, "alterno"));
                }
                
                if (p.unidad.includes('Unidad')) s.value = "manual_unidad";
                else if (p.unidad.includes('Kg')) s.value = "manual_kg";
                else if (p.unidad.includes('Docena')) s.value = "manual_docena";
            }
        }

        // ============================================================
        // 4. HISTORIAL Y MODOS
        // ============================================================
        
        window.toggleModoHistorial = function() {
            modoHistorial = modoHistorial === 'cronologico' ? 'agrupado' : 'cronologico';
            const btn = document.getElementById('btn-toggle-historial');
            if(btn) btn.innerHTML = modoHistorial === 'cronologico' ? '<i class="fas fa-layer-group mr-1"></i> Agrupar por Producto' : '<i class="fas fa-clock mr-1"></i> Ver Cronológico';
            actualizarHistorialVisual();
        }

        window.eliminarMovimiento = async function(id) {
            if (!isAdminUnlocked) return alert("Acceso denegado. Desbloquee Admin en Config.");
            if (!confirm("⚠️ ¿Borrar movimiento permanentemente? Esto afectará el stock.")) return;
            try { await db.collection(COLL_MOVIMIENTOS).doc(
