<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Producci√≥n - GASTRO</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f4f6f9; color: #333; }
        header { background-color: #343a40; color: white; padding: 15px; text-align: center; }
        h1 { margin: 0; font-size: 1.5rem; }
        .tabs { display: flex; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; font-weight: bold; }
        .tab.active { border-bottom: 3px solid #007bff; color: #007bff; }
        .content { display: none; padding: 20px; }
        .content.active { display: block; }
        
        /* Formularios */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input, textarea { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 150px; font-family: monospace; }
        
        button { width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
        button:hover { background-color: #218838; }
        button.delete { background-color: #dc3545; margin-top: 10px; }
        
        /* Tablas */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { padding: 10px; border: 1px solid #dee2e6; text-align: left; }
        th { background-color: #e9ecef; }
        
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
    </style>
</head>
<body>

<header>
    <h1>ü•ê CONTROL GASTRO WEB</h1>
</header>

<div class="tabs">
    <div class="tab active" onclick="cambiarTab('vista-cargar')">üìù CARGAR</div>
    <div class="tab" onclick="cambiarTab('vista-historial')">üìã HISTORIAL</div>
    <div class="tab" onclick="cambiarTab('vista-config')">‚öôÔ∏è CONFIG</div>
</div>

<div id="vista-cargar" class="content active">
    <div class="card">
        <div class="form-group">
            <label>Categor√≠a</label>
            <select id="sel-categoria" onchange="cargarProductosSelect()"></select>
        </div>
        <div class="form-group">
            <label>Producto</label>
            <select id="sel-producto"></select>
        </div>
        <div class="form-group">
            <label>Acci√≥n</label>
            <select id="sel-accion">
                <option value="ENTRADA">üü¢ PRODUCCI√ìN (Entrada)</option>
                <option value="SALIDA">üî¥ DESCARTE / MERMA (Salida)</option>
                <option value="REUTILIZACION">üîÑ REUTILIZACI√ìN (Neutro)</option>
            </select>
        </div>
        <div class="form-group">
            <label>Cantidad</label>
            <input type="number" id="inp-cantidad" placeholder="0" step="0.1">
        </div>
        <div class="form-group">
            <label>Operario (Opcional)</label>
            <select id="sel-operario"><option value="-">-- Seleccionar --</option></select>
        </div>
        <button onclick="guardarMovimiento()">GUARDAR MOVIMIENTO</button>
    </div>
</div>

<div id="vista-historial" class="content">
    <div class="card">
        <h3>√öltimos Movimientos</h3>
        <button onclick="cargarHistorial()" style="background-color: #007bff; margin-bottom: 10px;">üîÑ ACTUALIZAR LISTA</button>
        <div style="overflow-x: auto;">
            <table id="tabla-historial">
                <thead><tr><th>Fecha</th><th>Producto</th><th>Tipo</th><th>Cant</th><th>Operario</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="vista-config" class="content">
    <div class="card" style="border-left: 5px solid #ffc107;">
        <h3>‚ö†Ô∏è ADMINISTRACI√ìN DE PRODUCTOS</h3>
        <p>Edite los productos usando formato CSV: <b>ID, Nombre, Unidad, Alternativo, Factor, StockInicial</b></p>
        
        <label>PANADER√çA</label>
        <textarea id="config-panaderia"></textarea>
        
        <label>PASTELER√çA</label>
        <textarea id="config-pasteleria"></textarea>
        
        <label>COCINA</label>
        <textarea id="config-cocina"></textarea>
        
        <label>LISTA OPERARIOS (Separados por coma)</label>
        <input type="text" id="config-operarios">
        
        <button onclick="guardarConfiguracion()" style="margin-top: 20px;">üíæ GUARDAR CAMBIOS Y SINCRONIZAR</button>
    </div>
</div>

<script>
    // --- 1. CONFIGURACI√ìN FIREBASE (PEGA TU CONFIG AQU√ç SI ES DISTINTA) ---
    // El usuario debe poner sus propias credenciales si cambian, pero usamos la estructura est√°ndar.
    // REEMPLAZA ESTO CON TUS CLAVES SI NO FUNCIONA
    const firebaseConfig = {
        // ... TUS CREDENCIALES DE FIREBASE ...
        // Como no las tengo, asumo que ya sabes donde van o usas el archivo previo.
        // Si no tienes el config a mano, busca en tu archivo anterior la variable firebaseConfig
        apiKey: "TU_API_KEY",
        authDomain: "TU_PROJECT.firebaseapp.com",
        projectId: "TU_PROJECT_ID",
        storageBucket: "TU_PROJECT.appspot.com",
        messagingSenderId: "NUMERO",
        appId: "ID_APP"
    };
    
    // Inicializar Firebase (Evita error si ya existe)
    if (!firebase.apps.length) {
        // NOTA: Si no tienes las claves aqu√≠, el HTML no conectar√°. 
        // Aseg√∫rate de copiar las claves de tu archivo viejo si este no anda.
        // Para este ejemplo asumo que las tienes o las pegas aqu√≠.
        // firebase.initializeApp(firebaseConfig); 
        console.log("‚ö†Ô∏è RECUERDA PEGAR TUS CLAVES DE FIREBASE AQU√ç ARRIBA");
    } else {
        firebase.app(); 
    }
    
    // REFERENCIAS
    // const db = firebase.firestore(); // Descomentar cuando pongas las claves

    // =================================================================
    // L√ìGICA PRINCIPAL RESTAURADA
    // =================================================================
    
    const ORDEN_CATEGORIAS = ['panaderia', 'pasteleria', 'cocina'];
    const COLL_CONFIG = 'configuracion';
    
    function cambiarTab(id) {
        document.querySelectorAll('.content').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        // Activar visualmente el tab...
    }

    // --- GUARDADO DE CONFIGURACI√ìN (LA CLAVE PARA ARREGLAR PYTHON) ---
    window.guardarConfiguracion = async function() {
        // Simulaci√≥n de guardado si no hay DB conectada en este ejemplo de texto
        if (typeof db === 'undefined') { alert("Falta configurar Firebase en el c√≥digo HTML."); return; }

        const btn = document.querySelector('#vista-config button');
        btn.innerText = "GUARDANDO..."; btn.disabled = true;

        try {
            for (const key of ORDEN_CATEGORIAS) {
                const val = document.getElementById(`config-${key}`).value;
                const listaLimpia = procesarProductosCSV(val, key); 

                // GUARDADO LIMPIO QUE PYTHON ENTIENDE
                await db.collection(COLL_CONFIG).doc(`productos_${key}`).set({ 
                    csv: val,
                    json_data: listaLimpia, 
                    ultima_actualizacion: new Date().toISOString()
                });
            }
            
            const ops = document.getElementById('config-operarios').value;
            await db.collection(COLL_CONFIG).doc("operarios_lista").set({ lista: ops });
            
            alert("‚úÖ DATOS GUARDADOS. AHORA PYTHON FUNCIONAR√Å.");
            location.reload(); // Recargar para aplicar
        } catch(e) { 
            alert("Error: " + e.message); 
        } finally {
            btn.innerText = "üíæ GUARDAR CAMBIOS Y SINCRONIZAR"; btn.disabled = false;
        }
    }

    // Procesador CSV Simple
    function procesarProductosCSV(textoCSV, categoria) {
        const lineas = textoCSV.split('\n');
        const productos = [];
        lineas.forEach(linea => {
            const partes = linea.split(',');
            if (partes.length >= 2) {
                const id = partes[0].trim();
                const nombre = partes[1].trim();
                if (id && nombre) {
                    productos.push({
                        id: id,
                        nombre: nombre,
                        unidad: partes[2]?.trim() || 'Unidad',
                        alterno: partes[3]?.trim() || '-',
                        factor: partes[4]?.trim() || '1',
                        stockInicial: partes[5]?.trim() || '0',
                        categoria: categoria
                    });
                }
            }
        });
        return productos;
    }

    // ... (El resto de funciones de carga, historial, etc. se mantienen igual)
    // Para simplificar, enf√≥cate en que la funci√≥n guardarConfiguracion sea la de arriba.
</script>
</body>
</html>
