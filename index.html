<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panader칤a Control de Producci칩n</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // ============================================================
        // 1. CONFIGURACI칍N DE SEGURIDAD Y CLAVES
        // ============================================================
        const CLAVE_ADMIN = "2550LP"; // 游 CAMBIA ESTO

        const firebaseConfig = {
  apiKey: "AIzaSyBKV1mVfhFZJgeZRu6FHgz-2_KVrKDlHoc",
  authDomain: "mercaderia-f1699.firebaseapp.com",
  projectId: "mercaderia-f1699",
  storageBucket: "mercaderia-f1699.firebasestorage.app",
  messagingSenderId: "230493635490",
  appId: "1:230493635490:web:f4b780864dbc64eebda8fb"
};
    

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentUser = null;
        let productosGlobal = []; // Contiene TODAS las categor칤as
        let operariosGlobal = [];
        let movimientosGlobal = []; 
        let isAdminUnlocked = false; 
        
        const COLL_MOVIMIENTOS = "movimientos"; 
        const COLL_CONFIG = "configuracion";

        // Mapeo de Categor칤as para Firestore y UI
        const CATEGORIAS = {
            panaderia: 'Producci칩n Panader칤a',
            pasteleria: 'Producci칩n Pasteler칤a',
            cocina: 'Producci칩n Cocina'
        };

        // --- INICIALIZACI칍N ---
        document.addEventListener('DOMContentLoaded', () => {
            auth.signInAnonymously().catch(e => console.error("Error conexi칩n: ", e));
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('status-icon').classList.replace('text-red-500', 'text-green-400');
                    inicializarSistema();
                }
            });
            establecerFechaInput();
        });

        async function inicializarSistema() {
            await cargarConfiguracionGeneral();
            escucharMovimientos();
            // Cargar por defecto la primera categor칤a
            filtrarProductos('panaderia'); 
        }

        // --- GESTI칍N DE CONFIGURACI칍N ---
        
        // Listas por defecto (Panader칤a, Pasteler칤a, Cocina)
        const PRODUCTOS_DEFAULT_PANADERIA = `Media Luna Dulce | Unidad | Docena | 12 | 0
Media Luna Salada | Unidad | Docena | 12 | 0
Pan Franc칠s | Kg | Unidad | 0.5 | 0
Libritos | Kg | Docena | 0.3 | 0
Bizcochos | Kg | Paquete | 0.25 | 0`;
        const PRODUCTOS_DEFAULT_PASTELERIA = `Tarta Frutal | Unidad | Porci칩n | 6 | 0
Alfajor de Maicena | Unidad | Bandeja | 10 | 0`;
        const PRODUCTOS_DEFAULT_COCINA = `Prepizza de tomate | Unidad | Pack | 3 | 0
Prepizza de cebolla | Unidad | Pack | 3 | 0`;
        const OPERARIOS_DEFAULT = "Ma침ana\nTarde\nNoche";


        async function cargarConfiguracionGeneral() {
            try {
                // 1. Cargar Listas Categorizadas
                productosGlobal = [];
                for (const key in CATEGORIAS) {
                    const docRef = db.collection(COLL_CONFIG).doc(`productos_${key}`);
                    const docSnap = await docRef.get();
                    
                    let csv = getProductDefault(key);
                    if (docSnap.exists) csv = docSnap.data().csv;
                    else await docRef.set({ csv: csv });
                    
                    document.getElementById(`config-${key}`).value = csv;
                    productosGlobal.push(...procesarProductosCSV(csv, key));
                }

                // 2. Cargar Operarios
                const docOp = await db.collection(COLL_CONFIG).doc("operarios_lista").get();
                let txtOp = OPERARIOS_DEFAULT;
                if (docOp.exists) txtOp = docOp.data().lista;
                else await db.collection(COLL_CONFIG).doc("operarios_lista").set({ lista: OPERARIOS_DEFAULT });

                document.getElementById('config-operarios').value = txtOp;
                procesarOperarios(txtOp);

            } catch (e) {
                console.error("Error al cargar config general:", e);
            }
        }
        
        function getProductDefault(key) {
            if (key === 'panaderia') return PRODUCTOS_DEFAULT_PANADERIA;
            if (key === 'pasteleria') return PRODUCTOS_DEFAULT_PASTELERIA;
            if (key === 'cocina') return PRODUCTOS_DEFAULT_COCINA;
            return '';
        }

        function procesarProductosCSV(csvText, categoria) {
            return csvText.split('\n').map(l => l.trim()).filter(l => l.length > 0).map((l, i) => {
                const p = l.split('|').map(s => s.trim());
                return { 
                    id: `${categoria}_${i}`, 
                    categoria: categoria,
                    nombre: p[0], 
                    unidad: p[1] || 'Unidad', 
                    alterno: p[2] || '-', 
                    factor: parseFloat(p[3]) || 1, 
                    stockInicial: parseFloat(p[4]) || 0 
                };
            });
        }

        function procesarOperarios(txt) {
            operariosGlobal = txt.split('\n').map(s => s.trim()).filter(s => s.length > 0);
            llenarSelectOperarios();
        }

        // --- FILTROS Y DROPDOWNS ---
        
        function llenarSelectOperarios() {
            const sel = document.getElementById('operario');
            const actual = sel.value;
            sel.innerHTML = '';
            operariosGlobal.forEach(op => {
                const opt = document.createElement('option');
                opt.value = op; opt.text = op; sel.appendChild(opt);
            });
            if(actual) sel.value = actual;
        }
        
        window.filtrarProductos = function(categoria) {
            const sel = document.getElementById('producto');
            sel.innerHTML = '<option value="" disabled selected>Seleccione producto...</option>';
            
            // Si no hay categor칤a, o la categor칤a no existe, usa todo
            let filteredList = productosGlobal;
            if (categoria && CATEGORIAS.hasOwnProperty(categoria)) {
                filteredList = productosGlobal.filter(p => p.categoria === categoria);
                // Resaltar bot칩n activo
                document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('bg-amber-600', 'text-white'));
                document.getElementById(`btn-cat-${categoria}`).classList.add('bg-amber-600', 'text-white');
            }

            filteredList.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id; opt.text = p.nombre; sel.appendChild(opt);
            });
            actualizarFormato(); // Llamar para cargar unidades del primer producto
        }


        // --- VISTAS Y ACTUALIZACI칍N DE DATOS (Omitting repeated functions: actualizarPanelPrincipal, actualizarGraficos, etc., as they are the same V8 logic) ---

        // (Resto de las funciones de c치lculo, stock, y graficos son las mismas de V8)
        // ... (actualizarPanelPrincipal, actualizarGraficos, esHoy, etc.) ...
        
        // --- SEGURIDAD Y CONFIGURACI칍N ---

        function verificarAdmin() {
            if (isAdminUnlocked) return true;
            const pass = prompt("游 ACCESO RESTRINGIDO\nIngrese la contrase침a de Administrador:");
            if (pass === CLAVE_ADMIN) {
                isAdminUnlocked = true;
                return true;
            } else {
                alert("Contrase침a incorrecta.");
                return false;
            }
        }

        window.cambiarVista = function(id) {
            if (id === 'vista-config') {
                if (!verificarAdmin()) return; 
            }

            document.querySelectorAll('.vista').forEach(d => d.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('border-amber-300', 'text-white', 'font-bold');
                b.classList.add('border-transparent', 'text-amber-100');
            });
            const btn = document.getElementById('btn-' + id);
            if(btn) {
                 btn.classList.add('border-amber-300', 'text-white', 'font-bold');
                 btn.classList.remove('border-transparent', 'text-amber-100');
            }
        }
        
        window.guardarConfiguracion = async function() {
            if (!verificarAdmin()) return; 

            try {
                 // 1. Guardar listas categorizadas
                 for (const key in CATEGORIAS) {
                    const csv = document.getElementById(`config-${key}`).value;
                    await db.collection(COLL_CONFIG).doc(`productos_${key}`).set({ csv: csv });
                 }

                 // 2. Guardar Operarios
                const nuevosOps = document.getElementById('config-operarios').value;
                await db.collection(COLL_CONFIG).doc("operarios_lista").set({ lista: nuevosOps });
                
                // Recargar todo el sistema con las nuevas listas
                await cargarConfiguracionGeneral(); 
                alert("Configuraci칩n guardada correctamente. Productos y operarios actualizados.");
            } catch(e) { alert("Error al guardar config: " + e.message); }
        }

        // --- HERRAMIENTA DE CORRECCI칍N (ADMIN) ---
        
        window.eliminarMovimiento = async function(id) {
            if (!isAdminUnlocked) return alert("Acceso denegado. Desbloquee el modo Admin en Configuraci칩n.");
            if (!confirm("丘멆잺 쮻esea eliminar ESTE movimiento hist칩rico? Esto corregir치 su stock general. Esta acci칩n no se puede deshacer.")) return;

            try {
                await db.collection(COLL_MOVIMIENTOS).doc(id).delete();
                alert("Movimiento eliminado correctamente. Su stock se ha corregido.");
            } catch (error) {
                alert("Error al eliminar movimiento: " + error.message);
            }
        }

        // (Resto de las funciones ya est치n en el c칩digo anterior, incluyendo limpiarBaseDeDatos)
        // ...

    </script>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden text-gray-800 font-sans">

    <header class="bg-amber-700 text-white shadow-md flex-none z-20">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-bread-slice text-2xl text-amber-300"></i>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Panader칤a Control de Producci칩n</h1>
                    <p class="text-xs text-amber-300 opacity-80">Gesti칩n de Stock en Tiempo Real</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <i id="status-icon" class="fas fa-circle text-red-500 text-xs"></i>
            </div>
        </div>
    </header>

    <div class="bg-amber-800 shadow-inner flex-none">
        <div class="container mx-auto flex">
            </div>
    </div>

    <main class="flex-1 overflow-y-auto bg-gray-50 p-4 pb-20">

        <div id="vista-carga" class="vista hidden container mx-auto max-w-md">
            <div class="bg-white p-5 rounded-lg shadow-lg border-t-4 border-amber-500 space-y-5">
                <h2 class="text-lg font-bold text-gray-800 text-center border-b pb-2">Nueva Carga</h2>
                
                <div class="flex justify-between bg-gray-100 p-2 rounded-lg">
                    <button id="btn-cat-panaderia" onclick="filtrarProductos('panaderia')" class="cat-btn flex-1 py-1 px-1 text-xs font-bold rounded-md transition bg-amber-600 text-white">Panader칤a</button>
                    <button id="btn-cat-pasteleria" onclick="filtrarProductos('pasteleria')" class="cat-btn flex-1 py-1 px-1 text-xs font-bold rounded-md transition hover:bg-amber-100">Pasteler칤a</button>
                    <button id="btn-cat-cocina" onclick="filtrarProductos('cocina')" class="cat-btn flex-1 py-1 px-1 text-xs font-bold rounded-md transition hover:bg-amber-100">Cocina</button>
                </div>
                
                <form onsubmit="guardarMovimiento(event)" class="space-y-4">
                    <div>
                        <label class="lbl">Producto</label>
                        <select id="producto" onchange="actualizarFormato()" required class="input-field w-full bg-gray-50"></select>
                    </div>

                    </form>
            </div>
        </div>
        
        <div id="vista-historial" class="vista hidden container mx-auto max-w-4xl">
            <div class="flex justify-between items-center mb-2">
                 <h3 class="font-bold text-gray-700 text-sm">Historial de Movimientos</h3>
                <button id="btn-toggle-historial" onclick="toggleModoHistorial()" class="bg-white border border-gray-300 text-gray-600 px-3 py-1 rounded text-xs font-bold shadow-sm hover:bg-gray-50">
                    <i class="fas fa-layer-group mr-1"></i> Agrupar por Producto
                </button>
            </div>
            <div id="contenedor-historial" class="space-y-2">
                 </div>
        </div>

        <div id="vista-config" class="vista hidden container mx-auto max-w-lg space-y-6">
            
            <div class="bg-blue-50 border border-blue-200 p-3 rounded text-center text-blue-800 text-sm font-bold mb-4">
                <i class="fas fa-user-shield mr-2"></i> Modo Administrador Activo
            </div>

            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-400">
                <h3 class="font-bold text-gray-800 mb-1 text-sm">1. Editar Operarios</h3>
                <p class="text-xs text-gray-400 mb-2">Un nombre por l칤nea</p>
                <textarea id="config-operarios" class="w-full border p-2 text-sm h-24 rounded bg-gray-50"></textarea>
            </div>

            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-purple-400 space-y-4">
                <h3 class="font-bold text-gray-800 mb-1 text-sm">2. Editar Listas de Productos (Categor칤as)</h3>
                <p class="text-xs text-gray-400 mb-2">Formato: Nombre | Unidad | Alterno | Factor | Stock</p>
                
                <label class="lbl">Lista Panader칤a</label>
                <textarea id="config-panaderia" class="w-full border p-2 text-xs font-mono h-20 rounded bg-gray-50"></textarea>
                
                <label class="lbl">Lista Pasteler칤a</label>
                <textarea id="config-pasteleria" class="w-full border p-2 text-xs font-mono h-20 rounded bg-gray-50"></textarea>
                
                <label class="lbl">Lista Cocina</label>
                <textarea id="config-cocina" class="w-full border p-2 text-xs font-mono h-20 rounded bg-gray-50"></textarea>
            </div>

            <button onclick="guardarConfiguracion()" class="w-full bg-blue-600 text-white py-3 rounded font-bold text-sm shadow hover:bg-blue-700">
                <i class="fas fa-save mr-2"></i>GUARDAR TODOS LOS CAMBIOS
            </button>

            </div>

    </main>

    <style>
        .lbl { display: block; font-size: 0.7rem; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 2px; }
        .input-field { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: #d97706; box-shadow: 0 0 0 2px rgba(217, 119, 6, 0.2); }
    </style>
</body>
</html>
