<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
      
// ============================================================

 // 1. CONFIGURACIN DE SEGURIDAD Y CLAVES (DEBE QUEDAR AQU)
        // ============================================================
        const CLAVE_ADMIN = "2550LP"; //  CAMBIA ESTO

    const firebaseConfig = {
  apiKey: "AIzaSyBKV1mVfhFZJgeZRu6FHgz-2_KVrKDlHoc",
  authDomain: "mercaderia-f1699.firebaseapp.com",
  projectId: "mercaderia-f1699",
  storageBucket: "mercaderia-f1699.firebasestorage.app",
  messagingSenderId: "230493635490",
  appId: "1:230493635490:web:f4b780864dbc64eebda8fb"
};
       
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentUser = null;
        let productosGlobal = []; 
        let operariosGlobal = [];
        let movimientosGlobal = []; 
        let isAdminUnlocked = false; 
        
        const COLL_MOVIMIENTOS = "movimientos"; 
        const COLL_CONFIG = "configuracion";
        const CATEGORIAS = { panaderia: 'Producci贸n Panader铆a', pasteleria: 'Producci贸n Pasteler铆a', cocina: 'Producci贸n Cocina' };


        // ************************************************************
        // ********* 2. DEFINICIN DE TODAS LAS FUNCIONES (TOP) *******
        // ************************************************************

        // --- Funciones de Utilidad ---
        function obtenerFechaLocal() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0,16);
        }

        function establecerFechaInput() {
            const el = document.getElementById('fecha');
            if(el) el.value = obtenerFechaLocal(); // Agregado null check aqu铆
        }
        
        function getProductDefault(key) {
            if (key === 'panaderia') return `Media Luna Dulce | Unidad | Docena | 12 | 0\nMedia Luna Salada | Unidad | Docena | 12 | 0\nPan Franc茅s | Kg | Unidad | 0.5 | 0`;
            if (key === 'pasteleria') return `Tarta Frutal | Unidad | Porci贸n | 6 | 0\nAlfajor de Maicena | Unidad | Bandeja | 10 | 0`;
            if (key === 'cocina') return `Prepizza de tomate | Unidad | Pack | 3 | 0\nPrepizza de cebolla | Unidad | Pack | 3 | 0`;
            return '';
        }
        
        // --- Procesamiento de Datos ---
        function procesarProductosCSV(csvText, categoria) {
            return csvText.split('\n').map(l => l.trim()).filter(l => l.length > 0).map((l, i) => {
                const p = l.split('|').map(s => s.trim());
                return { 
                    id: `${categoria}_${i}`, 
                    categoria: categoria,
                    nombre: p[0], 
                    unidad: p[1] || 'Unidad', 
                    alterno: p[2] || '-', 
                    factor: parseFloat(p[3]) || 1, 
                    stockInicial: parseFloat(p[4]) || 0 
                };
            });
        }
        
        function procesarOperarios(txt) {
            operariosGlobal = txt.split('\n').map(s => s.trim()).filter(s => s.length > 0);
            llenarSelectOperarios();
        }

        // --- Manejo de UI y Dropdowns ---
        function llenarSelectOperarios() {
            const sel = document.getElementById('operario');
            if (!sel) return; // FIX: Seguridad contra error de null
            const actual = sel.value;
            sel.innerHTML = '';
            // ... (resto de la funci贸n)
            operariosGlobal.forEach(op => {
                const opt = document.createElement('option');
                opt.value = op; opt.text = op; sel.appendChild(opt);
            });
            if(actual) sel.value = actual;
        }

        function llenarSelectProductos() {
             const sel = document.getElementById('producto');
            const actual = sel.value;
            sel.innerHTML = '<option value="" disabled selected>Seleccione producto...</option>';
            // ... (resto de la funci贸n, usa productosGlobal para llenar)
            productosGlobal.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id; opt.text = p.nombre; sel.appendChild(opt);
            });
            if(actual) sel.value = actual;
        }

        window.actualizarFormato = function() {
            const p = productosGlobal.find(x => x.id === document.getElementById('producto').value);
            const s = document.getElementById('formato');
             if (!s) return; // FIX: Seguridad contra error de null
            s.innerHTML = '';
            // ... (resto de la funci贸n)
             if(p) {
                s.add(new Option("Unidad", "manual_unidad"));
                s.add(new Option("Docena", "manual_docena"));
                s.add(new Option("Kilogramo (Kg)", "manual_kg"));
                
                const isStandard = ['Docena', 'Kg', 'Unidad'].includes(p.alterno); 
                if(p.alterno && p.alterno !== '-' && !isStandard) {
                    s.add(new Option(`${p.alterno} (x${p.factor} ${p.unidad})`, "alterno"));
                }
                
                if (p.unidad.includes('Unidad')) s.value = "manual_unidad";
                else if (p.unidad.includes('Kg')) s.value = "kg_manual";
                else if (p.unidad.includes('Docena')) s.value = "docena_manual";
            }
        }
        
        // --- Carga y Escucha ---
        // (Copiar aqu铆 el resto de las funciones: escucharMovimientos, actualizarPanelPrincipal, etc.)
        // ...
        
        // --- Funci贸n principal de Inicializaci贸n ---
        async function inicializarSistema() {
            await cargarConfiguracionGeneral();
            escucharMovimientos(); // FIX: Ahora escuchaMovimientos est谩 definido arriba.
            filtrarProductos('panaderia'); 
        }

        async function cargarConfiguracionGeneral() {
            // FIX: La l贸gica de carga de Firestore debe estar aqu铆
            try {
                productosGlobal = [];
                for (const key in CATEGORIAS) {
                    const docRef = db.collection(COLL_CONFIG).doc(`productos_${key}`);
                    const docSnap = await docRef.get();
                    
                    let csv = getProductDefault(key);
                    if (docSnap.exists) csv = docSnap.data().csv;
                    else await docRef.set({ csv: csv });
                    
                    document.getElementById(`config-${key}`).value = csv;
                    productosGlobal.push(...procesarProductosCSV(csv, key));
                }

                const docOp = await db.collection(COLL_CONFIG).doc("operarios_lista").get();
                let txtOp = "Ma帽ana\nTarde\nNoche";
                if (docOp.exists) txtOp = docOp.data().lista;
                else await db.collection(COLL_CONFIG).doc("operarios_lista").set({ lista: txtOp });

                document.getElementById('config-operarios').value = txtOp;
                procesarOperarios(txtOp);

            } catch (e) {
                console.error("Error al cargar config general:", e);
            }
        }
        
        // --- Evento de Inicio ---
        // ************************************************************
        // ************** 3. LLAMADA DE INICIO DEL SISTEMA **************
        // ************************************************************
        document.addEventListener('DOMContentLoaded', () => {
            // FIX: Se llama a la funci贸n aqu铆, ahora definida arriba.
            establecerFechaInput(); 
            // La l贸gica de auth.onAuthStateChanged llama a inicializarSistema()
        });

        // (FIN DEL SCRIPT)
    </script>
